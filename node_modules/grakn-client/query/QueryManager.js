/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("grakn-client/query/QueryManager", ["require", "exports", "grakn-client/GraknOptions", "graknlabs-grpc-protocol/protobuf/query_pb", "graknlabs-grpc-protocol/protobuf/transaction_pb", "grakn-client/common/ProtoBuilder"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.QueryManager = void 0;
    const GraknOptions_1 = require("grakn-client/GraknOptions");
    const query_pb_1 = __importDefault(require("graknlabs-grpc-protocol/protobuf/query_pb"));
    var Query = query_pb_1.default.Query;
    var Graql = query_pb_1.default.Graql;
    const transaction_pb_1 = __importDefault(require("graknlabs-grpc-protocol/protobuf/transaction_pb"));
    var Transaction = transaction_pb_1.default.Transaction;
    const ProtoBuilder_1 = require("grakn-client/common/ProtoBuilder");
    class QueryManager {
        constructor(transaction) {
            this._rpcTransaction = transaction;
        }
        match(query, options) {
            const matchQuery = new Query.Req().setMatchReq(new Graql.Match.Req().setQuery(query));
            return this.iterateQuery(matchQuery, options ? options : new GraknOptions_1.GraknOptions(), (res) => res.getQueryRes().getMatchRes().getAnswerList());
        }
        insert(query, options) {
            const insertQuery = new Query.Req().setInsertReq(new Graql.Insert.Req().setQuery(query));
            return this.iterateQuery(insertQuery, options ? options : new GraknOptions_1.GraknOptions(), (res) => res.getQueryRes().getInsertRes().getAnswerList());
        }
        delete(query, options) {
            const deleteQuery = new Query.Req().setDeleteReq(new Graql.Delete.Req().setQuery(query));
            return this.runQuery(deleteQuery, options ? options : new GraknOptions_1.GraknOptions());
        }
        define(query, options) {
            const defineQuery = new Query.Req().setDefineReq(new Graql.Define.Req().setQuery(query));
            return this.runQuery(defineQuery, options ? options : new GraknOptions_1.GraknOptions());
        }
        undefine(query, options) {
            const undefineQuery = new Query.Req().setUndefineReq(new Graql.Undefine.Req().setQuery(query));
            return this.runQuery(undefineQuery, options ? options : new GraknOptions_1.GraknOptions());
        }
        runQuery(request, options) {
            return __awaiter(this, void 0, void 0, function* () {
                const transactionRequest = new Transaction.Req()
                    .setQueryReq(request.setOptions(ProtoBuilder_1.ProtoBuilder.options(options)));
                yield this._rpcTransaction.execute(transactionRequest);
            });
        }
        iterateQuery(request, options, responseReader) {
            const transactionRequest = new Transaction.Req()
                .setQueryReq(request.setOptions(ProtoBuilder_1.ProtoBuilder.options(options)));
            return this._rpcTransaction.stream(transactionRequest, responseReader);
        }
    }
    exports.QueryManager = QueryManager;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUXVlcnlNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcXVlcnkvUXVlcnlNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQUdILDREQUErQztJQUMvQyx5RkFBbUU7SUFDbkUsSUFBTyxLQUFLLEdBQUcsa0JBQVUsQ0FBQyxLQUFLLENBQUM7SUFDaEMsSUFBTyxLQUFLLEdBQUcsa0JBQVUsQ0FBQyxLQUFLLENBQUM7SUFDaEMscUdBQStFO0lBQy9FLElBQU8sV0FBVyxHQUFHLHdCQUFnQixDQUFDLFdBQVcsQ0FBQztJQUNsRCxtRUFBc0Q7SUFJdEQsTUFBYSxZQUFZO1FBRXJCLFlBQWEsV0FBMkI7WUFDcEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxXQUFXLENBQUM7UUFDdkMsQ0FBQztRQUVNLEtBQUssQ0FBQyxLQUFhLEVBQUUsT0FBc0I7WUFDOUMsTUFBTSxVQUFVLEdBQUcsSUFBSSxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUMxQyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDM0MsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSwyQkFBWSxFQUFFLEVBQUUsQ0FBQyxHQUFvQixFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQztRQUM1SixDQUFDO1FBRU0sTUFBTSxDQUFDLEtBQWEsRUFBRSxPQUFzQjtZQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQzVDLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUM1QyxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLDJCQUFZLEVBQUUsRUFBRSxDQUFDLEdBQW9CLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDO1FBQzlKLENBQUM7UUFFTSxNQUFNLENBQUMsS0FBYSxFQUFFLE9BQXNCO1lBQy9DLE1BQU0sV0FBVyxHQUFHLElBQUksS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FDNUMsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQzVDLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksMkJBQVksRUFBRSxDQUFDLENBQUE7UUFDN0UsQ0FBQztRQUVNLE1BQU0sQ0FBQyxLQUFhLEVBQUUsT0FBc0I7WUFDL0MsTUFBTSxXQUFXLEdBQUcsSUFBSSxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUNwQyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDcEQsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSwyQkFBWSxFQUFFLENBQUMsQ0FBQTtRQUM3RSxDQUFDO1FBRU0sUUFBUSxDQUFDLEtBQWEsRUFBRSxPQUFzQjtZQUNqRCxNQUFNLGFBQWEsR0FBRyxJQUFJLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxjQUFjLENBQ2hELElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUM5QyxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLDJCQUFZLEVBQUUsQ0FBQyxDQUFBO1FBQy9FLENBQUM7UUFFYSxRQUFRLENBQUMsT0FBa0IsRUFBRSxPQUFxQjs7Z0JBQzVELE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxXQUFXLENBQUMsR0FBRyxFQUFFO3FCQUMzQyxXQUFXLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQywyQkFBWSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BFLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUMzRCxDQUFDO1NBQUE7UUFFTyxZQUFZLENBQUksT0FBa0IsRUFBRSxPQUFxQixFQUFFLGNBQTZDO1lBQzVHLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxXQUFXLENBQUMsR0FBRyxFQUFFO2lCQUMzQyxXQUFXLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQywyQkFBWSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEUsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUMzRSxDQUFDO0tBQ0o7SUEvQ0Qsb0NBK0NDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbiAqIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuICogZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbiAqIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbiAqIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbiAqIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuICogc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbiAqIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4gKiBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbiAqIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IFJQQ1RyYW5zYWN0aW9uIH0gZnJvbSBcIi4uL3JwYy9SUENUcmFuc2FjdGlvblwiO1xuaW1wb3J0IHsgR3Jha25PcHRpb25zIH0gZnJvbSBcIi4uL0dyYWtuT3B0aW9uc1wiO1xuaW1wb3J0IFF1ZXJ5UHJvdG8gZnJvbSBcImdyYWtubGFicy1ncnBjLXByb3RvY29sL3Byb3RvYnVmL3F1ZXJ5X3BiXCI7XG5pbXBvcnQgUXVlcnkgPSBRdWVyeVByb3RvLlF1ZXJ5O1xuaW1wb3J0IEdyYXFsID0gUXVlcnlQcm90by5HcmFxbDtcbmltcG9ydCBUcmFuc2FjdGlvblByb3RvIGZyb20gXCJncmFrbmxhYnMtZ3JwYy1wcm90b2NvbC9wcm90b2J1Zi90cmFuc2FjdGlvbl9wYlwiO1xuaW1wb3J0IFRyYW5zYWN0aW9uID0gVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbjtcbmltcG9ydCB7IFByb3RvQnVpbGRlciB9IGZyb20gXCIuLi9jb21tb24vUHJvdG9CdWlsZGVyXCI7XG5pbXBvcnQgeyBTdHJlYW0gfSBmcm9tIFwiLi4vcnBjL1N0cmVhbVwiO1xuaW1wb3J0IHsgQ29uY2VwdE1hcCB9IGZyb20gXCIuLi9jb25jZXB0L0Fuc3dlci9Db25jZXB0TWFwXCI7XG5cbmV4cG9ydCBjbGFzcyBRdWVyeU1hbmFnZXIge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX3JwY1RyYW5zYWN0aW9uOiBSUENUcmFuc2FjdGlvbjtcbiAgICBjb25zdHJ1Y3RvciAodHJhbnNhY3Rpb246IFJQQ1RyYW5zYWN0aW9uKSB7XG4gICAgICAgIHRoaXMuX3JwY1RyYW5zYWN0aW9uID0gdHJhbnNhY3Rpb247XG4gICAgfVxuXG4gICAgcHVibGljIG1hdGNoKHF1ZXJ5OiBzdHJpbmcsIG9wdGlvbnM/OiBHcmFrbk9wdGlvbnMpOiBTdHJlYW08Q29uY2VwdE1hcD4ge1xuICAgICAgICBjb25zdCBtYXRjaFF1ZXJ5ID0gbmV3IFF1ZXJ5LlJlcSgpLnNldE1hdGNoUmVxKFxuICAgICAgICAgICAgbmV3IEdyYXFsLk1hdGNoLlJlcSgpLnNldFF1ZXJ5KHF1ZXJ5KSk7XG4gICAgICAgIHJldHVybiB0aGlzLml0ZXJhdGVRdWVyeShtYXRjaFF1ZXJ5LCBvcHRpb25zID8gb3B0aW9ucyA6IG5ldyBHcmFrbk9wdGlvbnMoKSwgKHJlczogVHJhbnNhY3Rpb24uUmVzKSA9PiByZXMuZ2V0UXVlcnlSZXMoKS5nZXRNYXRjaFJlcygpLmdldEFuc3dlckxpc3QoKSk7XG4gICAgfVxuXG4gICAgcHVibGljIGluc2VydChxdWVyeTogc3RyaW5nLCBvcHRpb25zPzogR3Jha25PcHRpb25zKTogU3RyZWFtPENvbmNlcHRNYXA+IHtcbiAgICAgICAgY29uc3QgaW5zZXJ0UXVlcnkgPSBuZXcgUXVlcnkuUmVxKCkuc2V0SW5zZXJ0UmVxKFxuICAgICAgICAgICAgbmV3IEdyYXFsLkluc2VydC5SZXEoKS5zZXRRdWVyeShxdWVyeSkpO1xuICAgICAgICByZXR1cm4gdGhpcy5pdGVyYXRlUXVlcnkoaW5zZXJ0UXVlcnksIG9wdGlvbnMgPyBvcHRpb25zIDogbmV3IEdyYWtuT3B0aW9ucygpLCAocmVzOiBUcmFuc2FjdGlvbi5SZXMpID0+IHJlcy5nZXRRdWVyeVJlcygpLmdldEluc2VydFJlcygpLmdldEFuc3dlckxpc3QoKSk7XG4gICAgfVxuXG4gICAgcHVibGljIGRlbGV0ZShxdWVyeTogc3RyaW5nLCBvcHRpb25zPzogR3Jha25PcHRpb25zKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGRlbGV0ZVF1ZXJ5ID0gbmV3IFF1ZXJ5LlJlcSgpLnNldERlbGV0ZVJlcShcbiAgICAgICAgICAgIG5ldyBHcmFxbC5EZWxldGUuUmVxKCkuc2V0UXVlcnkocXVlcnkpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMucnVuUXVlcnkoZGVsZXRlUXVlcnksIG9wdGlvbnMgPyBvcHRpb25zIDogbmV3IEdyYWtuT3B0aW9ucygpKVxuICAgIH1cblxuICAgIHB1YmxpYyBkZWZpbmUocXVlcnk6IHN0cmluZywgb3B0aW9ucz86IEdyYWtuT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBkZWZpbmVRdWVyeSA9IG5ldyBRdWVyeS5SZXEoKS5zZXREZWZpbmVSZXEoXG4gICAgICAgICAgICAgICAgICAgIG5ldyBHcmFxbC5EZWZpbmUuUmVxKCkuc2V0UXVlcnkocXVlcnkpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMucnVuUXVlcnkoZGVmaW5lUXVlcnksIG9wdGlvbnMgPyBvcHRpb25zIDogbmV3IEdyYWtuT3B0aW9ucygpKVxuICAgIH1cblxuICAgIHB1YmxpYyB1bmRlZmluZShxdWVyeTogc3RyaW5nLCBvcHRpb25zPzogR3Jha25PcHRpb25zKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHVuZGVmaW5lUXVlcnkgPSBuZXcgUXVlcnkuUmVxKCkuc2V0VW5kZWZpbmVSZXEoXG4gICAgICAgICAgICBuZXcgR3JhcWwuVW5kZWZpbmUuUmVxKCkuc2V0UXVlcnkocXVlcnkpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMucnVuUXVlcnkodW5kZWZpbmVRdWVyeSwgb3B0aW9ucyA/IG9wdGlvbnMgOiBuZXcgR3Jha25PcHRpb25zKCkpXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBydW5RdWVyeShyZXF1ZXN0OiBRdWVyeS5SZXEsIG9wdGlvbnM6IEdyYWtuT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCB0cmFuc2FjdGlvblJlcXVlc3QgPSBuZXcgVHJhbnNhY3Rpb24uUmVxKClcbiAgICAgICAgICAgIC5zZXRRdWVyeVJlcShyZXF1ZXN0LnNldE9wdGlvbnMoUHJvdG9CdWlsZGVyLm9wdGlvbnMob3B0aW9ucykpKTtcbiAgICAgICAgYXdhaXQgdGhpcy5fcnBjVHJhbnNhY3Rpb24uZXhlY3V0ZSh0cmFuc2FjdGlvblJlcXVlc3QpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXRlcmF0ZVF1ZXJ5PFQ+KHJlcXVlc3Q6IFF1ZXJ5LlJlcSwgb3B0aW9uczogR3Jha25PcHRpb25zLCByZXNwb25zZVJlYWRlcjogKHJlczogVHJhbnNhY3Rpb24uUmVzKSA9PiBUW10pOiBTdHJlYW08VD4ge1xuICAgICAgICBjb25zdCB0cmFuc2FjdGlvblJlcXVlc3QgPSBuZXcgVHJhbnNhY3Rpb24uUmVxKClcbiAgICAgICAgICAgIC5zZXRRdWVyeVJlcShyZXF1ZXN0LnNldE9wdGlvbnMoUHJvdG9CdWlsZGVyLm9wdGlvbnMob3B0aW9ucykpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3JwY1RyYW5zYWN0aW9uLnN0cmVhbSh0cmFuc2FjdGlvblJlcXVlc3QsIHJlc3BvbnNlUmVhZGVyKTtcbiAgICB9XG59XG4iXX0=