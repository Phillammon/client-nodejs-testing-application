/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("grakn-client/query/QueryManager", ["require", "exports", "grakn-client/dependencies_internal", "graknlabs-protocol/protobuf/query_pb", "graknlabs-protocol/protobuf/transaction_pb"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.QueryManager = void 0;
    const dependencies_internal_1 = require("grakn-client/dependencies_internal");
    const query_pb_1 = __importDefault(require("graknlabs-protocol/protobuf/query_pb"));
    var Query = query_pb_1.default.Query;
    var Graql = query_pb_1.default.Graql;
    const transaction_pb_1 = __importDefault(require("graknlabs-protocol/protobuf/transaction_pb"));
    var Transaction = transaction_pb_1.default.Transaction;
    class QueryManager {
        constructor(transaction) {
            this._rpcTransaction = transaction;
        }
        match(query, options) {
            const matchQuery = new Query.Req().setMatchReq(new Graql.Match.Req().setQuery(query));
            return this.iterateQuery(matchQuery, options ? options : new dependencies_internal_1.GraknOptions(), (res) => res.getQueryRes().getMatchRes().getAnswerList().map(dependencies_internal_1.ConceptMap.of));
        }
        insert(query, options) {
            const insertQuery = new Query.Req().setInsertReq(new Graql.Insert.Req().setQuery(query));
            return this.iterateQuery(insertQuery, options ? options : new dependencies_internal_1.GraknOptions(), (res) => res.getQueryRes().getInsertRes().getAnswerList().map(dependencies_internal_1.ConceptMap.of));
        }
        delete(query, options) {
            const deleteQuery = new Query.Req().setDeleteReq(new Graql.Delete.Req().setQuery(query));
            return this.runQuery(deleteQuery, options ? options : new dependencies_internal_1.GraknOptions());
        }
        define(query, options) {
            const defineQuery = new Query.Req().setDefineReq(new Graql.Define.Req().setQuery(query));
            return this.runQuery(defineQuery, options ? options : new dependencies_internal_1.GraknOptions());
        }
        undefine(query, options) {
            const undefineQuery = new Query.Req().setUndefineReq(new Graql.Undefine.Req().setQuery(query));
            return this.runQuery(undefineQuery, options ? options : new dependencies_internal_1.GraknOptions());
        }
        runQuery(request, options) {
            return __awaiter(this, void 0, void 0, function* () {
                const transactionRequest = new Transaction.Req()
                    .setQueryReq(request.setOptions(dependencies_internal_1.ProtoBuilder.options(options)));
                yield this._rpcTransaction.execute(transactionRequest);
            });
        }
        iterateQuery(request, options, responseReader) {
            const transactionRequest = new Transaction.Req()
                .setQueryReq(request.setOptions(dependencies_internal_1.ProtoBuilder.options(options)));
            return this._rpcTransaction.stream(transactionRequest, responseReader);
        }
    }
    exports.QueryManager = QueryManager;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUXVlcnlNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcXVlcnkvUXVlcnlNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQUVILDhFQU1rQztJQUNsQyxvRkFBOEQ7SUFDOUQsSUFBTyxLQUFLLEdBQUcsa0JBQVUsQ0FBQyxLQUFLLENBQUM7SUFDaEMsSUFBTyxLQUFLLEdBQUcsa0JBQVUsQ0FBQyxLQUFLLENBQUM7SUFDaEMsZ0dBQTBFO0lBQzFFLElBQU8sV0FBVyxHQUFHLHdCQUFnQixDQUFDLFdBQVcsQ0FBQztJQUVsRCxNQUFhLFlBQVk7UUFFckIsWUFBYSxXQUEyQjtZQUNwQyxJQUFJLENBQUMsZUFBZSxHQUFHLFdBQVcsQ0FBQztRQUN2QyxDQUFDO1FBRU0sS0FBSyxDQUFDLEtBQWEsRUFBRSxPQUFzQjtZQUM5QyxNQUFNLFVBQVUsR0FBRyxJQUFJLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQzFDLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUMzQyxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLG9DQUFZLEVBQUUsRUFBRSxDQUFDLEdBQW9CLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxHQUFHLENBQUMsa0NBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQy9LLENBQUM7UUFFTSxNQUFNLENBQUMsS0FBYSxFQUFFLE9BQXNCO1lBQy9DLE1BQU0sV0FBVyxHQUFHLElBQUksS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FDNUMsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQzVDLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksb0NBQVksRUFBRSxFQUFFLENBQUMsR0FBb0IsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDLFlBQVksRUFBRSxDQUFDLGFBQWEsRUFBRSxDQUFDLEdBQUcsQ0FBQyxrQ0FBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDakwsQ0FBQztRQUVNLE1BQU0sQ0FBQyxLQUFhLEVBQUUsT0FBc0I7WUFDL0MsTUFBTSxXQUFXLEdBQUcsSUFBSSxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUM1QyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDNUMsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxvQ0FBWSxFQUFFLENBQUMsQ0FBQTtRQUM3RSxDQUFDO1FBRU0sTUFBTSxDQUFDLEtBQWEsRUFBRSxPQUFzQjtZQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQ3BDLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNwRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLG9DQUFZLEVBQUUsQ0FBQyxDQUFBO1FBQzdFLENBQUM7UUFFTSxRQUFRLENBQUMsS0FBYSxFQUFFLE9BQXNCO1lBQ2pELE1BQU0sYUFBYSxHQUFHLElBQUksS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLGNBQWMsQ0FDaEQsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQzlDLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksb0NBQVksRUFBRSxDQUFDLENBQUE7UUFDL0UsQ0FBQztRQUVhLFFBQVEsQ0FBQyxPQUFrQixFQUFFLE9BQXFCOztnQkFDNUQsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLFdBQVcsQ0FBQyxHQUFHLEVBQUU7cUJBQzNDLFdBQVcsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLG9DQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDcEUsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQzNELENBQUM7U0FBQTtRQUVPLFlBQVksQ0FBSSxPQUFrQixFQUFFLE9BQXFCLEVBQUUsY0FBNkM7WUFDNUcsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLFdBQVcsQ0FBQyxHQUFHLEVBQUU7aUJBQzNDLFdBQVcsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLG9DQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwRSxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLGtCQUFrQixFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQzNFLENBQUM7S0FDSjtJQS9DRCxvQ0ErQ0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuICogb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4gKiBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuICogcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuICogdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuICogXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4gKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuICogXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbiAqIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuICogc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuICogdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHtcbiAgICBSUENUcmFuc2FjdGlvbixcbiAgICBHcmFrbk9wdGlvbnMsXG4gICAgUHJvdG9CdWlsZGVyLFxuICAgIFN0cmVhbSxcbiAgICBDb25jZXB0TWFwLFxufSBmcm9tIFwiLi4vZGVwZW5kZW5jaWVzX2ludGVybmFsXCI7XG5pbXBvcnQgUXVlcnlQcm90byBmcm9tIFwiZ3Jha25sYWJzLXByb3RvY29sL3Byb3RvYnVmL3F1ZXJ5X3BiXCI7XG5pbXBvcnQgUXVlcnkgPSBRdWVyeVByb3RvLlF1ZXJ5O1xuaW1wb3J0IEdyYXFsID0gUXVlcnlQcm90by5HcmFxbDtcbmltcG9ydCBUcmFuc2FjdGlvblByb3RvIGZyb20gXCJncmFrbmxhYnMtcHJvdG9jb2wvcHJvdG9idWYvdHJhbnNhY3Rpb25fcGJcIjtcbmltcG9ydCBUcmFuc2FjdGlvbiA9IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb247XG5cbmV4cG9ydCBjbGFzcyBRdWVyeU1hbmFnZXIge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX3JwY1RyYW5zYWN0aW9uOiBSUENUcmFuc2FjdGlvbjtcbiAgICBjb25zdHJ1Y3RvciAodHJhbnNhY3Rpb246IFJQQ1RyYW5zYWN0aW9uKSB7XG4gICAgICAgIHRoaXMuX3JwY1RyYW5zYWN0aW9uID0gdHJhbnNhY3Rpb247XG4gICAgfVxuXG4gICAgcHVibGljIG1hdGNoKHF1ZXJ5OiBzdHJpbmcsIG9wdGlvbnM/OiBHcmFrbk9wdGlvbnMpOiBTdHJlYW08Q29uY2VwdE1hcD4ge1xuICAgICAgICBjb25zdCBtYXRjaFF1ZXJ5ID0gbmV3IFF1ZXJ5LlJlcSgpLnNldE1hdGNoUmVxKFxuICAgICAgICAgICAgbmV3IEdyYXFsLk1hdGNoLlJlcSgpLnNldFF1ZXJ5KHF1ZXJ5KSk7XG4gICAgICAgIHJldHVybiB0aGlzLml0ZXJhdGVRdWVyeShtYXRjaFF1ZXJ5LCBvcHRpb25zID8gb3B0aW9ucyA6IG5ldyBHcmFrbk9wdGlvbnMoKSwgKHJlczogVHJhbnNhY3Rpb24uUmVzKSA9PiByZXMuZ2V0UXVlcnlSZXMoKS5nZXRNYXRjaFJlcygpLmdldEFuc3dlckxpc3QoKS5tYXAoQ29uY2VwdE1hcC5vZikpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpbnNlcnQocXVlcnk6IHN0cmluZywgb3B0aW9ucz86IEdyYWtuT3B0aW9ucyk6IFN0cmVhbTxDb25jZXB0TWFwPiB7XG4gICAgICAgIGNvbnN0IGluc2VydFF1ZXJ5ID0gbmV3IFF1ZXJ5LlJlcSgpLnNldEluc2VydFJlcShcbiAgICAgICAgICAgIG5ldyBHcmFxbC5JbnNlcnQuUmVxKCkuc2V0UXVlcnkocXVlcnkpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaXRlcmF0ZVF1ZXJ5KGluc2VydFF1ZXJ5LCBvcHRpb25zID8gb3B0aW9ucyA6IG5ldyBHcmFrbk9wdGlvbnMoKSwgKHJlczogVHJhbnNhY3Rpb24uUmVzKSA9PiByZXMuZ2V0UXVlcnlSZXMoKS5nZXRJbnNlcnRSZXMoKS5nZXRBbnN3ZXJMaXN0KCkubWFwKENvbmNlcHRNYXAub2YpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZGVsZXRlKHF1ZXJ5OiBzdHJpbmcsIG9wdGlvbnM/OiBHcmFrbk9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgZGVsZXRlUXVlcnkgPSBuZXcgUXVlcnkuUmVxKCkuc2V0RGVsZXRlUmVxKFxuICAgICAgICAgICAgbmV3IEdyYXFsLkRlbGV0ZS5SZXEoKS5zZXRRdWVyeShxdWVyeSkpO1xuICAgICAgICByZXR1cm4gdGhpcy5ydW5RdWVyeShkZWxldGVRdWVyeSwgb3B0aW9ucyA/IG9wdGlvbnMgOiBuZXcgR3Jha25PcHRpb25zKCkpXG4gICAgfVxuXG4gICAgcHVibGljIGRlZmluZShxdWVyeTogc3RyaW5nLCBvcHRpb25zPzogR3Jha25PcHRpb25zKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGRlZmluZVF1ZXJ5ID0gbmV3IFF1ZXJ5LlJlcSgpLnNldERlZmluZVJlcShcbiAgICAgICAgICAgICAgICAgICAgbmV3IEdyYXFsLkRlZmluZS5SZXEoKS5zZXRRdWVyeShxdWVyeSkpO1xuICAgICAgICByZXR1cm4gdGhpcy5ydW5RdWVyeShkZWZpbmVRdWVyeSwgb3B0aW9ucyA/IG9wdGlvbnMgOiBuZXcgR3Jha25PcHRpb25zKCkpXG4gICAgfVxuXG4gICAgcHVibGljIHVuZGVmaW5lKHF1ZXJ5OiBzdHJpbmcsIG9wdGlvbnM/OiBHcmFrbk9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgdW5kZWZpbmVRdWVyeSA9IG5ldyBRdWVyeS5SZXEoKS5zZXRVbmRlZmluZVJlcShcbiAgICAgICAgICAgIG5ldyBHcmFxbC5VbmRlZmluZS5SZXEoKS5zZXRRdWVyeShxdWVyeSkpO1xuICAgICAgICByZXR1cm4gdGhpcy5ydW5RdWVyeSh1bmRlZmluZVF1ZXJ5LCBvcHRpb25zID8gb3B0aW9ucyA6IG5ldyBHcmFrbk9wdGlvbnMoKSlcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIHJ1blF1ZXJ5KHJlcXVlc3Q6IFF1ZXJ5LlJlcSwgb3B0aW9uczogR3Jha25PcHRpb25zKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uUmVxdWVzdCA9IG5ldyBUcmFuc2FjdGlvbi5SZXEoKVxuICAgICAgICAgICAgLnNldFF1ZXJ5UmVxKHJlcXVlc3Quc2V0T3B0aW9ucyhQcm90b0J1aWxkZXIub3B0aW9ucyhvcHRpb25zKSkpO1xuICAgICAgICBhd2FpdCB0aGlzLl9ycGNUcmFuc2FjdGlvbi5leGVjdXRlKHRyYW5zYWN0aW9uUmVxdWVzdCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpdGVyYXRlUXVlcnk8VD4ocmVxdWVzdDogUXVlcnkuUmVxLCBvcHRpb25zOiBHcmFrbk9wdGlvbnMsIHJlc3BvbnNlUmVhZGVyOiAocmVzOiBUcmFuc2FjdGlvbi5SZXMpID0+IFRbXSk6IFN0cmVhbTxUPiB7XG4gICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uUmVxdWVzdCA9IG5ldyBUcmFuc2FjdGlvbi5SZXEoKVxuICAgICAgICAgICAgLnNldFF1ZXJ5UmVxKHJlcXVlc3Quc2V0T3B0aW9ucyhQcm90b0J1aWxkZXIub3B0aW9ucyhvcHRpb25zKSkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fcnBjVHJhbnNhY3Rpb24uc3RyZWFtKHRyYW5zYWN0aW9uUmVxdWVzdCwgcmVzcG9uc2VSZWFkZXIpO1xuICAgIH1cbn1cbiJdfQ==