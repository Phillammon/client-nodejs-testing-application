/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("grakn-client/rpc/RPCTransaction", ["require", "exports", "grakn-client/Grakn", "grakn-client/concept/ConceptManager", "graknlabs-grpc-protocol/protobuf/transaction_pb", "grakn-client/common/ProtoBuilder", "grakn-client/query/QueryManager", "grakn-client/common/utils", "grakn-client/common/BlockingQueue", "grakn-client/rpc/Stream"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.ResponseCollector = exports.RPCTransaction = void 0;
    const Grakn_1 = require("grakn-client/Grakn");
    const ConceptManager_1 = require("grakn-client/concept/ConceptManager");
    const transaction_pb_1 = __importDefault(require("graknlabs-grpc-protocol/protobuf/transaction_pb"));
    const ProtoBuilder_1 = require("grakn-client/common/ProtoBuilder");
    const QueryManager_1 = require("grakn-client/query/QueryManager");
    const utils_1 = require("grakn-client/common/utils");
    const BlockingQueue_1 = require("grakn-client/common/BlockingQueue");
    const Stream_1 = require("grakn-client/rpc/Stream");
    class RPCTransaction {
        constructor(grpcClient, type) {
            this._type = type;
            this._conceptManager = new ConceptManager_1.ConceptManager(this);
            this._queryManager = new QueryManager_1.QueryManager(this);
            this._collectors = new ResponseCollectors(this);
            this._transactionWasClosed = false;
            this._transactionWasOpened = false;
            this._streamIsOpen = false;
            this._grpcClient = grpcClient;
        }
        open(sessionId, options) {
            return __awaiter(this, void 0, void 0, function* () {
                this.openTransactionStream();
                this._streamIsOpen = true;
                const openRequest = new transaction_pb_1.default.Transaction.Req()
                    .setOpenReq(new transaction_pb_1.default.Transaction.Open.Req()
                    .setSessionId(sessionId)
                    .setType(this._type === Grakn_1.Grakn.TransactionType.READ ? transaction_pb_1.default.Transaction.Type.READ : transaction_pb_1.default.Transaction.Type.WRITE)
                    .setOptions(ProtoBuilder_1.ProtoBuilder.options(options)));
                const startTime = new Date().getTime();
                const res = yield this.execute(openRequest, res => res.getOpenRes());
                const endTime = new Date().getTime();
                this._networkLatencyMillis = endTime - startTime - res.getProcessingTimeMillis();
                this._transactionWasOpened = true;
                return this;
            });
        }
        type() {
            return this._type;
        }
        isOpen() {
            return this._transactionWasOpened && !this._transactionWasClosed;
        }
        concepts() {
            return this._conceptManager;
        }
        query() {
            return this._queryManager;
        }
        commit() {
            return __awaiter(this, void 0, void 0, function* () {
                const commitReq = new transaction_pb_1.default.Transaction.Req()
                    .setCommitReq(new transaction_pb_1.default.Transaction.Commit.Req());
                yield this.execute(commitReq);
            });
        }
        rollback() {
            return __awaiter(this, void 0, void 0, function* () {
                const rollbackReq = new transaction_pb_1.default.Transaction.Req()
                    .setRollbackReq(new transaction_pb_1.default.Transaction.Rollback.Req());
                yield this.execute(rollbackReq);
            });
        }
        close() {
            return __awaiter(this, void 0, void 0, function* () {
                if (this._streamIsOpen) {
                    this._streamIsOpen = false;
                    // TODO: close stream, somehow?
                }
                if (!this._transactionWasClosed) {
                    this._transactionWasClosed = true;
                    this._collectors.clearWithError(new ErrorResponse("Transaction closed."));
                }
            });
        }
        execute(request, transformResponse = () => null) {
            const responseCollector = new ResponseCollector();
            const requestId = utils_1.uuidv4();
            request.setId(requestId);
            this._collectors.put(requestId, responseCollector);
            // TODO: we can optionally inject the callback here - perhaps that would be cleaner than using ResponseCollectors?
            this._stream.write(request);
            return responseCollector.take().then(transformResponse);
        }
        stream(request, transformResponse) {
            const responseCollector = new ResponseCollector();
            const requestId = utils_1.uuidv4();
            request.setId(requestId);
            request.setLatencyMillis(this._networkLatencyMillis);
            this._collectors.put(requestId, responseCollector);
            this._stream.write(request);
            return new Stream_1.Stream(requestId, this._stream, responseCollector, transformResponse);
        }
        openTransactionStream() {
            this._stream = this._grpcClient.transaction();
            this._stream.on("data", (res) => {
                const requestId = res.getId();
                const collector = this._collectors.get(requestId);
                if (!collector)
                    throw "Unknown request ID " + requestId;
                collector.add(new OkResponse(res));
            });
            this._stream.on("error", (err) => {
                console.error(err);
            });
            this._stream.on("end", () => {
                this._streamIsOpen = false;
                this.close();
            });
            // TODO: look into _stream.on(status) + any other events
        }
    }
    exports.RPCTransaction = RPCTransaction;
    class ResponseCollectors {
        constructor(transaction) {
            this._map = {};
            this._transaction = transaction;
        }
        get(uuid) {
            return this._map[uuid];
        }
        put(uuid, collector) {
            if (this._transaction["_transactionWasClosed"])
                throw "The transaction has been closed and no further operation is allowed.";
            this._map[uuid] = collector;
        }
        remove(uuid) {
            delete this._map[uuid];
        }
        clearWithError(error) {
            Object.keys(this._map).forEach((requestId) => this._map[requestId].add(error));
            for (const requestId in this._map)
                delete this._map[requestId];
        }
    }
    class ResponseCollector {
        constructor() {
            this._responseBuffer = new BlockingQueue_1.BlockingQueue();
        }
        add(response) {
            this._responseBuffer.add(response);
        }
        take() {
            return __awaiter(this, void 0, void 0, function* () {
                const response = yield this._responseBuffer.take();
                return response.read();
            });
        }
    }
    exports.ResponseCollector = ResponseCollector;
    class Response {
    }
    class OkResponse extends Response {
        constructor(res) {
            super();
            this._res = res;
        }
        read() {
            return this._res;
        }
        toString() {
            return "OkResponse {" + this._res.toString() + "}";
        }
    }
    class ErrorResponse extends Response {
        constructor(error) {
            super();
            this._error = error;
        }
        read() {
            throw this._error;
        }
        toString() {
            return "ErrorResponse {" + this._error.toString() + "}";
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUlBDVHJhbnNhY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9ycGMvUlBDVHJhbnNhY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBRUgsOENBQWlDO0lBQ2pDLHdFQUEyRDtJQUMzRCxxR0FBK0U7SUFDL0UsbUVBQXNEO0lBSXRELGtFQUFxRDtJQUVyRCxxREFBeUM7SUFDekMscUVBQXdEO0lBQ3hELG9EQUFrQztJQUVsQyxNQUFhLGNBQWM7UUFhdkIsWUFBWSxVQUFxQixFQUFFLElBQTJCO1lBQzFELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1lBQ2xCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSwrQkFBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSwyQkFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNoRCxJQUFJLENBQUMscUJBQXFCLEdBQUcsS0FBSyxDQUFDO1lBQ25DLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxLQUFLLENBQUM7WUFDbkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7WUFDM0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUM7UUFDbEMsQ0FBQztRQUVLLElBQUksQ0FBQyxTQUFpQixFQUFFLE9BQXNCOztnQkFDaEQsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7Z0JBQzdCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO2dCQUUxQixNQUFNLFdBQVcsR0FBRyxJQUFJLHdCQUFnQixDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUU7cUJBQ3JELFVBQVUsQ0FDUCxJQUFJLHdCQUFnQixDQUFDLFdBQVcsQ0FBQyxJ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QUM7UUFDdEIsQ0FBQztRQUVELFFBQVE7WUFDSixPQUFPLGlCQUFpQixHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEdBQUcsR0FBRyxDQUFDO1FBQzVELENBQUM7S0FDSiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4gKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbiAqIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4gKiByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4gKiB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4gKiBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbiAqIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4gKiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuICogS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4gKiBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4gKiB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBHcmFrbiB9IGZyb20gXCIuLi9HcmFrblwiO1xuaW1wb3J0IHsgQ29uY2VwdE1hbmFnZXIgfSBmcm9tIFwiLi4vY29uY2VwdC9Db25jZXB0TWFuYWdlclwiO1xuaW1wb3J0IFRyYW5zYWN0aW9uUHJvdG8gZnJvbSBcImdyYWtubGFicy1ncnBjLXByb3RvY29sL3Byb3RvYnVmL3RyYW5zYWN0aW9uX3BiXCI7XG5pbXBvcnQgeyBQcm90b0J1aWxkZXIgfSBmcm9tIFwiLi4vY29tbW9uL1Byb3RvQnVpbGRlclwiO1xuaW1wb3J0IEdyYWtuUHJvdG8gZnJvbSBcImdyYWtubGFicy1ncnBjLXByb3RvY29sL3Byb3RvYnVmL2dyYWtuX2dycGNfcGJcIjtcbmltcG9ydCBHcmFrbkdycGMgPSBHcmFrblByb3RvLkdyYWtuQ2xpZW50O1xuaW1wb3J0IHsgR3Jha25PcHRpb25zIH0gZnJvbSBcIi4uL0dyYWtuT3B0aW9uc1wiO1xuaW1wb3J0IHsgUXVlcnlNYW5hZ2VyIH0gZnJvbSBcIi4uL3F1ZXJ5L1F1ZXJ5TWFuYWdlclwiO1xuaW1wb3J0IHsgQ2xpZW50RHVwbGV4U3RyZWFtIH0gZnJvbSBcIkBncnBjL2dycGMtanNcIjtcbmltcG9ydCB7IHV1aWR2NCB9IGZyb20gXCIuLi9jb21tb24vdXRpbHNcIjtcbmltcG9ydCB7IEJsb2NraW5nUXVldWUgfSBmcm9tIFwiLi4vY29tbW9uL0Jsb2NraW5nUXVldWVcIjtcbmltcG9ydCB7IFN0cmVhbSB9IGZyb20gXCIuL1N0cmVhbVwiO1xuXG5leHBvcnQgY2xhc3MgUlBDVHJhbnNhY3Rpb24gaW1wbGVtZW50cyBHcmFrbi5UcmFuc2FjdGlvbiB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfdHlwZTogR3Jha24uVHJhbnNhY3Rpb25UeXBlO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2NvbmNlcHRNYW5hZ2VyOiBDb25jZXB0TWFuYWdlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9xdWVyeU1hbmFnZXI6IFF1ZXJ5TWFuYWdlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9jb2xsZWN0b3JzOiBSZXNwb25zZUNvbGxlY3RvcnM7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfZ3JwY0NsaWVudDogR3Jha25HcnBjO1xuXG4gICAgcHJpdmF0ZSBfc3RyZWFtOiBDbGllbnREdXBsZXhTdHJlYW08VHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXEsIFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVzPjtcbiAgICBwcml2YXRlIF9zdHJlYW1Jc09wZW46IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfdHJhbnNhY3Rpb25XYXNPcGVuZWQ6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfdHJhbnNhY3Rpb25XYXNDbG9zZWQ6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfbmV0d29ya0xhdGVuY3lNaWxsaXM6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKGdycGNDbGllbnQ6IEdyYWtuR3JwYywgdHlwZTogR3Jha24uVHJhbnNhY3Rpb25UeXBlKSB7XG4gICAgICAgIHRoaXMuX3R5cGUgPSB0eXBlO1xuICAgICAgICB0aGlzLl9jb25jZXB0TWFuYWdlciA9IG5ldyBDb25jZXB0TWFuYWdlcih0aGlzKTtcbiAgICAgICAgdGhpcy5fcXVlcnlNYW5hZ2VyID0gbmV3IFF1ZXJ5TWFuYWdlcih0aGlzKTtcbiAgICAgICAgdGhpcy5fY29sbGVjdG9ycyA9IG5ldyBSZXNwb25zZUNvbGxlY3RvcnModGhpcyk7XG4gICAgICAgIHRoaXMuX3RyYW5zYWN0aW9uV2FzQ2xvc2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX3RyYW5zYWN0aW9uV2FzT3BlbmVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX3N0cmVhbUlzT3BlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9ncnBjQ2xpZW50ID0gZ3JwY0NsaWVudDtcbiAgICB9XG5cbiAgICBhc3luYyBvcGVuKHNlc3Npb25JZDogc3RyaW5nLCBvcHRpb25zPzogR3Jha25PcHRpb25zKTogUHJvbWlzZTxSUENUcmFuc2FjdGlvbj4ge1xuICAgICAgICB0aGlzLm9wZW5UcmFuc2FjdGlvblN0cmVhbSgpO1xuICAgICAgICB0aGlzLl9zdHJlYW1Jc09wZW4gPSB0cnVlO1xuXG4gICAgICAgIGNvbnN0IG9wZW5SZXF1ZXN0ID0gbmV3IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVxKClcbiAgICAgICAgICAgIC5zZXRPcGVuUmVxKFxuICAgICAgICAgICAgICAgIG5ldyBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLk9wZW4uUmVxKClcbiAgICAgICAgICAgICAgICAgICAgLnNldFNlc3Npb25JZChzZXNzaW9uSWQpXG4gICAgICAgICAgICAgICAgICAgIC5zZXRUeXBlKHRoaXMuX3R5cGUgPT09IEdyYWtuLlRyYW5zYWN0aW9uVHlwZS5SRUFEID8gVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5UeXBlLlJFQUQgOiBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlR5cGUuV1JJVEUpXG4gICAgICAgICAgICAgICAgICAgIC5zZXRPcHRpb25zKFByb3RvQnVpbGRlci5vcHRpb25zKG9wdGlvbnMpKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZXhlY3V0ZShvcGVuUmVxdWVzdCwgcmVzID0+IHJlcy5nZXRPcGVuUmVzKCkpO1xuICAgICAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgIHRoaXMuX25ldHdvcmtMYXRlbmN5TWlsbGlzID0gZW5kVGltZSAtIHN0YXJ0VGltZSAtIHJlcy5nZXRQcm9jZXNzaW5nVGltZU1pbGxpcygpO1xuICAgICAgICB0aGlzLl90cmFuc2FjdGlvbldhc09wZW5lZCA9IHRydWU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB0eXBlKCk6IEdyYWtuLlRyYW5zYWN0aW9uVHlwZSB7XG4gICAgICAgIHJldHVybiB0aGlzLl90eXBlO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc09wZW4oKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl90cmFuc2FjdGlvbldhc09wZW5lZCAmJiAhdGhpcy5fdHJhbnNhY3Rpb25XYXNDbG9zZWQ7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbmNlcHRzKCk6IENvbmNlcHRNYW5hZ2VyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmNlcHRNYW5hZ2VyO1xuICAgIH1cblxuICAgIHB1YmxpYyBxdWVyeSgpOiBRdWVyeU1hbmFnZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fcXVlcnlNYW5hZ2VyO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBjb21taXQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGNvbW1pdFJlcSA9IG5ldyBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJlcSgpXG4gICAgICAgICAgICAuc2V0Q29tbWl0UmVxKG5ldyBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLkNvbW1pdC5SZXEoKSk7XG4gICAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZShjb21taXRSZXEpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyByb2xsYmFjaygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3Qgcm9sbGJhY2tSZXEgPSBuZXcgVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXEoKVxuICAgICAgICAgICAgLnNldFJvbGxiYWNrUmVxKG5ldyBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJvbGxiYWNrLlJlcSgpKTtcbiAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlKHJvbGxiYWNrUmVxKTtcbiAgICB9XG5cbiAgICBhc3luYyBjbG9zZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKHRoaXMuX3N0cmVhbUlzT3Blbikge1xuICAgICAgICAgICAgdGhpcy5fc3RyZWFtSXNPcGVuID0gZmFsc2U7XG4gICAgICAgICAgICAvLyBUT0RPOiBjbG9zZSBzdHJlYW0sIHNvbWVob3c/XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLl90cmFuc2FjdGlvbldhc0Nsb3NlZCkge1xuICAgICAgICAgICAgdGhpcy5fdHJhbnNhY3Rpb25XYXNDbG9zZWQgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5fY29sbGVjdG9ycy5jbGVhcldpdGhFcnJvcihuZXcgRXJyb3JSZXNwb25zZShcIlRyYW5zYWN0aW9uIGNsb3NlZC5cIikpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBleGVjdXRlPFQ+KHJlcXVlc3Q6IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVxLCB0cmFuc2Zvcm1SZXNwb25zZTogKHJlczogVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXMpID0+IFQgPSAoKSA9PiBudWxsKTogUHJvbWlzZTxUPiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlQ29sbGVjdG9yID0gbmV3IFJlc3BvbnNlQ29sbGVjdG9yKCk7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RJZCA9IHV1aWR2NCgpO1xuICAgICAgICByZXF1ZXN0LnNldElkKHJlcXVlc3RJZCk7XG4gICAgICAgIHRoaXMuX2NvbGxlY3RvcnMucHV0KHJlcXVlc3RJZCwgcmVzcG9uc2VDb2xsZWN0b3IpO1xuICAgICAgICAvLyBUT0RPOiB3ZSBjYW4gb3B0aW9uYWxseSBpbmplY3QgdGhlIGNhbGxiYWNrIGhlcmUgLSBwZXJoYXBzIHRoYXQgd291bGQgYmUgY2xlYW5lciB0aGFuIHVzaW5nIFJlc3BvbnNlQ29sbGVjdG9ycz9cbiAgICAgICAgdGhpcy5fc3RyZWFtLndyaXRlKHJlcXVlc3QpO1xuICAgICAgICByZXR1cm4gcmVzcG9uc2VDb2xsZWN0b3IudGFrZSgpLnRoZW4odHJhbnNmb3JtUmVzcG9uc2UpO1xuICAgIH1cblxuICAgIHN0cmVhbTxUPihyZXF1ZXN0OiBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJlcSwgdHJhbnNmb3JtUmVzcG9uc2U6IChyZXM6IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVzKSA9PiBUW10pOiBTdHJlYW08VD4ge1xuICAgICAgICBjb25zdCByZXNwb25zZUNvbGxlY3RvciA9IG5ldyBSZXNwb25zZUNvbGxlY3RvcigpO1xuICAgICAgICBjb25zdCByZXF1ZXN0SWQgPSB1dWlkdjQoKTtcbiAgICAgICAgcmVxdWVzdC5zZXRJZChyZXF1ZXN0SWQpO1xuICAgICAgICByZXF1ZXN0LnNldExhdGVuY3lNaWxsaXModGhpcy5fbmV0d29ya0xhdGVuY3lNaWxsaXMpO1xuICAgICAgICB0aGlzLl9jb2xsZWN0b3JzLnB1dChyZXF1ZXN0SWQsIHJlc3BvbnNlQ29sbGVjdG9yKTtcbiAgICAgICAgdGhpcy5fc3RyZWFtLndyaXRlKHJlcXVlc3QpO1xuICAgICAgICByZXR1cm4gbmV3IFN0cmVhbTxUPihyZXF1ZXN0SWQsIHRoaXMuX3N0cmVhbSwgcmVzcG9uc2VDb2xsZWN0b3IsIHRyYW5zZm9ybVJlc3BvbnNlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9wZW5UcmFuc2FjdGlvblN0cmVhbSgpIHtcbiAgICAgICAgdGhpcy5fc3RyZWFtID0gdGhpcy5fZ3JwY0NsaWVudC50cmFuc2FjdGlvbigpO1xuXG4gICAgICAgIHRoaXMuX3N0cmVhbS5vbihcImRhdGFcIiwgKHJlcykgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdElkID0gcmVzLmdldElkKCk7XG4gICAgICAgICAgICBjb25zdCBjb2xsZWN0b3IgPSB0aGlzLl9jb2xsZWN0b3JzLmdldChyZXF1ZXN0SWQpO1xuICAgICAgICAgICAgaWYgKCFjb2xsZWN0b3IpIHRocm93IFwiVW5rbm93biByZXF1ZXN0IElEIFwiICsgcmVxdWVzdElkO1xuICAgICAgICAgICAgY29sbGVjdG9yLmFkZChuZXcgT2tSZXNwb25zZShyZXMpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fc3RyZWFtLm9uKFwiZXJyb3JcIiwgKGVycikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl9zdHJlYW0ub24oXCJlbmRcIiwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fc3RyZWFtSXNPcGVuID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBUT0RPOiBsb29rIGludG8gX3N0cmVhbS5vbihzdGF0dXMpICsgYW55IG90aGVyIGV2ZW50c1xuICAgIH1cbn1cblxuY2xhc3MgUmVzcG9uc2VDb2xsZWN0b3JzIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9tYXA6IHsgW3JlcXVlc3RJZDogc3RyaW5nXTogUmVzcG9uc2VDb2xsZWN0b3IgfTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF90cmFuc2FjdGlvbjogUlBDVHJhbnNhY3Rpb247XG4gICAgY29uc3RydWN0b3IodHJhbnNhY3Rpb246IFJQQ1RyYW5zYWN0aW9uKSB7XG4gICAgICAgIHRoaXMuX21hcCA9IHt9O1xuICAgICAgICB0aGlzLl90cmFuc2FjdGlvbiA9IHRyYW5zYWN0aW9uO1xuICAgIH1cblxuICAgIGdldCh1dWlkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX21hcFt1dWlkXTtcbiAgICB9XG5cbiAgICBwdXQodXVpZDogc3RyaW5nLCBjb2xsZWN0b3I6IFJlc3BvbnNlQ29sbGVjdG9yKSB7XG4gICAgICAgIGlmICh0aGlzLl90cmFuc2FjdGlvbltcIl90cmFuc2FjdGlvbldhc0Nsb3NlZFwiXSkgdGhyb3cgXCJUaGUgdHJhbnNhY3Rpb24gaGFzIGJlZW4gY2xvc2VkIGFuZCBubyBmdXJ0aGVyIG9wZXJhdGlvbiBpcyBhbGxvd2VkLlwiXG4gICAgICAgIHRoaXMuX21hcFt1dWlkXSA9IGNvbGxlY3RvcjtcbiAgICB9XG5cbiAgICByZW1vdmUodXVpZDogc3RyaW5nKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9tYXBbdXVpZF07XG4gICAgfVxuXG4gICAgY2xlYXJXaXRoRXJyb3IoZXJyb3I6IEVycm9yUmVzcG9uc2UpIHtcbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5fbWFwKS5mb3JFYWNoKChyZXF1ZXN0SWQpID0+IHRoaXMuX21hcFtyZXF1ZXN0SWRdLmFkZChlcnJvcikpO1xuICAgICAgICBmb3IgKGNvbnN0IHJlcXVlc3RJZCBpbiB0aGlzLl9tYXApIGRlbGV0ZSB0aGlzLl9tYXBbcmVxdWVzdElkXTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZXNwb25zZUNvbGxlY3RvciB7XG4gICAgcHJpdmF0ZSBfcmVzcG9uc2VCdWZmZXI6IEJsb2NraW5nUXVldWU8UmVzcG9uc2U+O1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuX3Jlc3BvbnNlQnVmZmVyID0gbmV3IEJsb2NraW5nUXVldWU8UmVzcG9uc2U+KCk7XG4gICAgfVxuXG4gICAgYWRkKHJlc3BvbnNlOiBSZXNwb25zZSk6IHZvaWQge1xuICAgICAgICB0aGlzLl9yZXNwb25zZUJ1ZmZlci5hZGQocmVzcG9uc2UpO1xuICAgIH1cblxuICAgIGFzeW5jIHRha2UoKTogUHJvbWlzZTxUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJlcz4ge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuX3Jlc3BvbnNlQnVmZmVyLnRha2UoKTtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlYWQoKTtcbiAgICB9XG59XG5cbmFic3RyYWN0IGNsYXNzIFJlc3BvbnNlIHtcbiAgICBhYnN0cmFjdCByZWFkKCk6IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVzO1xufVxuXG5jbGFzcyBPa1Jlc3BvbnNlIGV4dGVuZHMgUmVzcG9uc2Uge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX3JlczogVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXM7XG5cbiAgICBjb25zdHJ1Y3RvcihyZXM6IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVzKSB7XG4gICAgICAgIHN1cGVyKClcbiAgICAgICAgdGhpcy5fcmVzID0gcmVzO1xuICAgIH1cblxuICAgIHJlYWQoKTogVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXMge1xuICAgICAgICByZXR1cm4gdGhpcy5fcmVzO1xuICAgIH1cblxuICAgIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBcIk9rUmVzcG9uc2Uge1wiICsgdGhpcy5fcmVzLnRvU3RyaW5nKCkgKyBcIn1cIjtcbiAgICB9XG59XG5cbmNsYXNzIEVycm9yUmVzcG9uc2UgZXh0ZW5kcyBSZXNwb25zZSB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfZXJyb3I6IEVycm9yIHwgc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IoZXJyb3I6IEVycm9yIHwgc3RyaW5nKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuX2Vycm9yID0gZXJyb3I7XG4gICAgfVxuXG4gICAgcmVhZCgpOiBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJlcyB7XG4gICAgICAgIHRocm93IHRoaXMuX2Vycm9yO1xuICAgIH1cblxuICAgIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBcIkVycm9yUmVzcG9uc2Uge1wiICsgdGhpcy5fZXJyb3IudG9TdHJpbmcoKSArIFwifVwiO1xuICAgIH1cbn1cbiJdfQ==