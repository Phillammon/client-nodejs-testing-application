/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("grakn-client/rpc/RPCTransaction", ["require", "exports", "grakn-client/dependencies_internal", "graknlabs-grpc-protocol/protobuf/transaction_pb"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.ResponseCollector = exports.RPCTransaction = void 0;
    const dependencies_internal_1 = require("grakn-client/dependencies_internal");
    const transaction_pb_1 = __importDefault(require("graknlabs-grpc-protocol/protobuf/transaction_pb"));
    class RPCTransaction {
        constructor(grpcClient, type) {
            this._type = type;
            this._conceptManager = new dependencies_internal_1.ConceptManager(this);
            this._queryManager = new dependencies_internal_1.QueryManager(this);
            this._collectors = new ResponseCollectors(this);
            this._transactionWasClosed = false;
            this._transactionWasOpened = false;
            this._streamIsOpen = false;
            this._grpcClient = grpcClient;
        }
        open(sessionId, options) {
            return __awaiter(this, void 0, void 0, function* () {
                this.openTransactionStream();
                this._streamIsOpen = true;
                const openRequest = new transaction_pb_1.default.Transaction.Req()
                    .setOpenReq(new transaction_pb_1.default.Transaction.Open.Req()
                    .setSessionId(sessionId)
                    .setType(this._type === dependencies_internal_1.Grakn.TransactionType.READ ? transaction_pb_1.default.Transaction.Type.READ : transaction_pb_1.default.Transaction.Type.WRITE)
                    .setOptions(dependencies_internal_1.ProtoBuilder.options(options)));
                const startTime = new Date().getTime();
                const res = yield this.execute(openRequest, res => res.getOpenRes());
                const endTime = new Date().getTime();
                this._networkLatencyMillis = endTime - startTime - res.getProcessingTimeMillis();
                this._transactionWasOpened = true;
                return this;
            });
        }
        type() {
            return this._type;
        }
        isOpen() {
            return this._transactionWasOpened && !this._transactionWasClosed;
        }
        concepts() {
            return this._conceptManager;
        }
        query() {
            return this._queryManager;
        }
        commit() {
            return __awaiter(this, void 0, void 0, function* () {
                const commitReq = new transaction_pb_1.default.Transaction.Req()
                    .setCommitReq(new transaction_pb_1.default.Transaction.Commit.Req());
                yield this.execute(commitReq);
            });
        }
        rollback() {
            return __awaiter(this, void 0, void 0, function* () {
                const rollbackReq = new transaction_pb_1.default.Transaction.Req()
                    .setRollbackReq(new transaction_pb_1.default.Transaction.Rollback.Req());
                yield this.execute(rollbackReq);
            });
        }
        close() {
            return __awaiter(this, void 0, void 0, function* () {
                if (this._streamIsOpen) {
                    this._streamIsOpen = false;
                    // TODO: close stream, somehow?
                }
                if (!this._transactionWasClosed) {
                    this._transactionWasClosed = true;
                    this._collectors.clearWithError(new ErrorResponse("Transaction closed."));
                }
            });
        }
        execute(request, transformResponse = () => null) {
            const responseCollector = new ResponseCollector();
            const requestId = dependencies_internal_1.uuidv4();
            request.setId(requestId);
            this._collectors.put(requestId, responseCollector);
            // TODO: we can optionally inject the callback here - perhaps that would be cleaner than using ResponseCollectors?
            this._stream.write(request);
            return responseCollector.take().then(transformResponse);
        }
        stream(request, transformResponse) {
            const responseCollector = new ResponseCollector();
            const requestId = dependencies_internal_1.uuidv4();
            request.setId(requestId);
            request.setLatencyMillis(this._networkLatencyMillis);
            this._collectors.put(requestId, responseCollector);
            this._stream.write(request);
            return new dependencies_internal_1.Stream(requestId, this._stream, responseCollector, transformResponse);
        }
        openTransactionStream() {
            this._stream = this._grpcClient.transaction();
            this._stream.on("data", (res) => {
                const requestId = res.getId();
                const collector = this._collectors.get(requestId);
                if (!collector)
                    throw "Unknown request ID " + requestId;
                collector.add(new OkResponse(res));
            });
            this._stream.on("error", (err) => {
                console.error(err);
            });
            this._stream.on("end", () => {
                this._streamIsOpen = false;
                this.close();
            });
            // TODO: look into _stream.on(status) + any other events
        }
    }
    exports.RPCTransaction = RPCTransaction;
    class ResponseCollectors {
        constructor(transaction) {
            this._map = {};
            this._transaction = transaction;
        }
        get(uuid) {
            return this._map[uuid];
        }
        put(uuid, collector) {
            if (this._transaction["_transactionWasClosed"])
                throw "The transaction has been closed and no further operation is allowed.";
            this._map[uuid] = collector;
        }
        clearWithError(error) {
            Object.keys(this._map).forEach((requestId) => this._map[requestId].add(error));
            for (const requestId in this._map)
                delete this._map[requestId];
        }
    }
    class ResponseCollector {
        constructor() {
            this._responseBuffer = new dependencies_internal_1.BlockingQueue();
        }
        add(response) {
            this._responseBuffer.add(response);
        }
        take() {
            return __awaiter(this, void 0, void 0, function* () {
                const response = yield this._responseBuffer.take();
                return response.read();
            });
        }
    }
    exports.ResponseCollector = ResponseCollector;
    class Response {
    }
    class OkResponse extends Response {
        constructor(res) {
            super();
            this._res = res;
        }
        read() {
            return this._res;
        }
        toString() {
            return "OkResponse {" + this._res.toString() + "}";
        }
    }
    class ErrorResponse extends Response {
        constructor(error) {
            super();
            this._error = error;
        }
        read() {
            throw this._error;
        }
        toString() {
            return "ErrorResponse {" + this._error.toString() + "}";
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUlBDVHJhbnNhY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9ycGMvUlBDVHJhbnNhY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBRUgsOEVBU2tDO0lBQ2xDLHFHQUErRTtJQUsvRSxNQUFhLGNBQWM7UUFhdkIsWUFBWSxVQUFxQixFQUFFLElBQTJCO1lBQzFELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1lBQ2xCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxzQ0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxvQ0FBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNoRCxJQUFJLENBQUMscUJBQXFCLEdBQUcsS0FBSyxDQUFDO1lBQ25DLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxLQUFLLENBQUM7WUFDbkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7WUFDM0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUM7UUFDbEMsQ0FBQztRQUVLLElBQUksQ0FBQyxTQUFpQixFQUFFLE9BQXNCOztnQkFDaEQsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7Z0JBQzdCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO2dCQUUxQixNQUFNLFdBQVcsR0FBRyxJQUFJLHdCQUFnQixDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUU7cUJBQ3JELFVBQVUsQ0FDUCxJQUFJLHdCQUFnQixDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO3FCQUN0QyxZQUFZLENBQUMsU0FBUyxDQUFDO3FCQUN2QixPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyw2QkFBSyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLHdCQUFnQixDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyx3QkFBZ0IsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztxQkFDckksVUFBVSxDQUFDLG9DQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQ2pELENBQUM7Z0JBQ04sTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDdkMsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO2dCQUNyRSxNQUFNLE9BQU8sR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNyQyxJQUFJLENBQUMscUJBQXFCLEdBQUcsT0FBTyxHQUFHLFNBQVMsR0FBRyxHQUFHLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztnQkFDakYsSUFBSSxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQztnQkFDbEMsT0FBTyxJQUFJLENBQUM7WUFDaEIsQ0FBQztTQUFBO1FBRU0sSUFBSTtZQUNQLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN0QixDQUFDO1FBRU0sTUFBTTtZQUNULE9BQU8sSUFBSSxDQUFDLHFCQUFxQixJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDO1FBQ3JFLENBQUM7UUFFTSxRQUFRO1lBQ1gsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDO1FBQ2hDLENBQUM7UUFFTSxLQUFLO1lBQ1IsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQzlCLENBQUM7UUFFWSxNQUFNOztnQkFDZixNQUFNLFNBQVMsR0FBRyxJQUFJLHdCQUFnQixDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUU7cUJBQ25ELFlBQVksQ0FBQyxJQUFJLHdCQUFnQixDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDakUsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2xDLENBQUM7U0FBQTtRQUVZLFFBQVE7O2dCQUNqQixNQUFNLFdBQVcsR0FBRyxJQUFJLHdCQUFnQixDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUU7cUJBQ3JELGNBQWMsQ0FBQyxJQUFJLHdCQUFnQixDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDckUsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3BDLENBQUM7U0FBQTtRQUVLLEtBQUs7O2dCQUNQLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtvQkFDcEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7b0JBQzNCLCtCQUErQjtpQkFDbEM7Z0JBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtvQkFDN0IsSUFBSSxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQztvQkFDbEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsSUFBSSxhQUFhLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFBO2lCQUM1RTtZQUNMLENBQUM7U0FBQTtRQUVELE9BQU8sQ0FBSSxPQUF5QyxFQUFFLG9CQUFrRSxHQUFHLEVBQUUsQ0FBQyxJQUFJO1lBQzlILE1BQU0saUJBQWlCLEdBQUcsSUFBSSxpQkFBaUIsRUFBRSxDQUFDO1lBQ2xELE1BQU0sU0FBUyxHQUFHLDhCQUFNLEVBQUUsQ0FBQztZQUMzQixPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3pCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1lBQ25ELGtIQUFrSDtZQUNsSCxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM1QixPQUFPLGlCQUFpQixDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQzVELENBQUM7UUFFRCxNQUFNLENBQUksT0FBeUMsRUFBRSxpQkFBaUU7WUFDbEgsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLGlCQUFpQixFQUFFLENBQUM7WUFDbEQsTUFBTSxTQUFTLEdBQUcsOEJBQU0sRUFBRSxDQUFDO1lBQzNCLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDekIsT0FBTyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1lBQ3JELElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzVCLE9BQU8sSUFBSSw4QkFBTSxDQUFJLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDeEYsQ0FBQztRQUVPLHFCQUFxQjtZQUN6QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUM7WUFFOUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0JBQzVCLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDOUIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ2xELElBQUksQ0FBQyxTQUFTO29CQUFFLE1BQU0scUJBQXFCLEdBQUcsU0FBUyxDQUFDO2dCQUN4RCxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDdkMsQ0FBQyxDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRTtnQkFDN0IsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN2QixDQUFDLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUU7Z0JBQ3hCLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDO2dCQUMzQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDakIsQ0FBQyxDQUFDLENBQUM7WUFDSCx3REFBd0Q7UUFDNUQsQ0FBQztLQUNKO0lBMUhELHdDQTBIQztJQUVELE1BQU0sa0JBQWtCO1FBR3BCLFlBQVksV0FBMkI7WUFDbkMsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsWUFBWSxHQUFHLFdBQVcsQ0FBQztRQUNwQyxDQUFDO1FBRUQsR0FBRyxDQUFDLElBQVk7WUFDWixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0IsQ0FBQztRQUVELEdBQUcsQ0FBQyxJQUFZLEVBQUUsU0FBNEI7WUFDMUMsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLHVCQUF1QixDQUFDO2dCQUFFLE1BQU0sc0VBQXNFLENBQUE7WUFDNUgsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxTQUFTLENBQUM7UUFDaEMsQ0FBQztRQUVELGNBQWMsQ0FBQyxLQUFvQjtZQUMvQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDL0UsS0FBSyxNQUFNLFNBQVMsSUFBSSxJQUFJLENBQUMsSUFBSTtnQkFBRSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbkUsQ0FBQztLQUNKO0lBRUQsTUFBYSxpQkFBaUI7UUFHMUI7WUFDSSxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUkscUNBQWEsRUFBWSxDQUFDO1FBQ3pELENBQUM7UUFFRCxHQUFHLENBQUMsUUFBa0I7WUFDbEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkMsQ0FBQztRQUVLLElBQUk7O2dCQUNOLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDbkQsT0FBTyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDM0IsQ0FBQztTQUFBO0tBQ0o7SUFmRCw4Q0FlQztJQUVELE1BQWUsUUFBUTtLQUV0QjtJQUVELE1BQU0sVUFBVyxTQUFRLFFBQVE7UUFHN0IsWUFBWSxHQUFxQztZQUM3QyxLQUFLLEVBQUUsQ0FBQTtZQUNQLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO1FBQ3BCLENBQUM7UUFFRCxJQUFJO1lBQ0EsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3JCLENBQUM7UUFFRCxRQUFRO1lBQ0osT0FBTyxjQUFjLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxHQUFHLENBQUM7UUFDdkQsQ0FBQztLQUNKO0lBRUQsTUFBTSxhQUFjLFNBQVEsUUFBUTtRQUdoQyxZQUFZLEtBQXFCO1lBQzdCLEtBQUssRUFBRSxDQUFDO1lBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7UUFDeEIsQ0FBQztRQUVELElBQUk7WUFDQSxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDdEIsQ0FBQztRQUVELFFBQVE7WUFDSixPQUFPLGlCQUFpQixHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEdBQUcsR0FBRyxDQUFDO1FBQzVELENBQUM7S0FDSiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBMaWNlbnNlZCB0byB0aGUgQXBhY2hlIFNvZnR3YXJlIEZvdW5kYXRpb24gKEFTRikgdW5kZXIgb25lXG4gKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxpY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGVcbiAqIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4gKiByZWdhcmRpbmcgY29weXJpZ2h0IG93bmVyc2hpcC4gIFRoZSBBU0YgbGljZW5zZXMgdGhpcyBmaWxlXG4gKiB0byB5b3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlXG4gKiBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbiAqIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4gKiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuICogS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4gKiBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4gKiB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICAgIEdyYWtuLFxuICAgIENvbmNlcHRNYW5hZ2VyLFxuICAgIFByb3RvQnVpbGRlcixcbiAgICBHcmFrbk9wdGlvbnMsXG4gICAgUXVlcnlNYW5hZ2VyLFxuICAgIHV1aWR2NCxcbiAgICBCbG9ja2luZ1F1ZXVlLFxuICAgIFN0cmVhbSxcbn0gZnJvbSBcIi4uL2RlcGVuZGVuY2llc19pbnRlcm5hbFwiO1xuaW1wb3J0IFRyYW5zYWN0aW9uUHJvdG8gZnJvbSBcImdyYWtubGFicy1ncnBjLXByb3RvY29sL3Byb3RvYnVmL3RyYW5zYWN0aW9uX3BiXCI7XG5pbXBvcnQgR3Jha25Qcm90byBmcm9tIFwiZ3Jha25sYWJzLWdycGMtcHJvdG9jb2wvcHJvdG9idWYvZ3Jha25fZ3JwY19wYlwiO1xuaW1wb3J0IEdyYWtuR3JwYyA9IEdyYWtuUHJvdG8uR3Jha25DbGllbnQ7XG5pbXBvcnQgeyBDbGllbnREdXBsZXhTdHJlYW0gfSBmcm9tIFwiQGdycGMvZ3JwYy1qc1wiO1xuXG5leHBvcnQgY2xhc3MgUlBDVHJhbnNhY3Rpb24gaW1wbGVtZW50cyBHcmFrbi5UcmFuc2FjdGlvbiB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfdHlwZTogR3Jha24uVHJhbnNhY3Rpb25UeXBlO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2NvbmNlcHRNYW5hZ2VyOiBDb25jZXB0TWFuYWdlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9xdWVyeU1hbmFnZXI6IFF1ZXJ5TWFuYWdlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9jb2xsZWN0b3JzOiBSZXNwb25zZUNvbGxlY3RvcnM7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfZ3JwY0NsaWVudDogR3Jha25HcnBjO1xuXG4gICAgcHJpdmF0ZSBfc3RyZWFtOiBDbGllbnREdXBsZXhTdHJlYW08VHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXEsIFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVzPjtcbiAgICBwcml2YXRlIF9zdHJlYW1Jc09wZW46IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfdHJhbnNhY3Rpb25XYXNPcGVuZWQ6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfdHJhbnNhY3Rpb25XYXNDbG9zZWQ6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfbmV0d29ya0xhdGVuY3lNaWxsaXM6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKGdycGNDbGllbnQ6IEdyYWtuR3JwYywgdHlwZTogR3Jha24uVHJhbnNhY3Rpb25UeXBlKSB7XG4gICAgICAgIHRoaXMuX3R5cGUgPSB0eXBlO1xuICAgICAgICB0aGlzLl9jb25jZXB0TWFuYWdlciA9IG5ldyBDb25jZXB0TWFuYWdlcih0aGlzKTtcbiAgICAgICAgdGhpcy5fcXVlcnlNYW5hZ2VyID0gbmV3IFF1ZXJ5TWFuYWdlcih0aGlzKTtcbiAgICAgICAgdGhpcy5fY29sbGVjdG9ycyA9IG5ldyBSZXNwb25zZUNvbGxlY3RvcnModGhpcyk7XG4gICAgICAgIHRoaXMuX3RyYW5zYWN0aW9uV2FzQ2xvc2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX3RyYW5zYWN0aW9uV2FzT3BlbmVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX3N0cmVhbUlzT3BlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9ncnBjQ2xpZW50ID0gZ3JwY0NsaWVudDtcbiAgICB9XG5cbiAgICBhc3luYyBvcGVuKHNlc3Npb25JZDogc3RyaW5nLCBvcHRpb25zPzogR3Jha25PcHRpb25zKTogUHJvbWlzZTxSUENUcmFuc2FjdGlvbj4ge1xuICAgICAgICB0aGlzLm9wZW5UcmFuc2FjdGlvblN0cmVhbSgpO1xuICAgICAgICB0aGlzLl9zdHJlYW1Jc09wZW4gPSB0cnVlO1xuXG4gICAgICAgIGNvbnN0IG9wZW5SZXF1ZXN0ID0gbmV3IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVxKClcbiAgICAgICAgICAgIC5zZXRPcGVuUmVxKFxuICAgICAgICAgICAgICAgIG5ldyBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLk9wZW4uUmVxKClcbiAgICAgICAgICAgICAgICAgICAgLnNldFNlc3Npb25JZChzZXNzaW9uSWQpXG4gICAgICAgICAgICAgICAgICAgIC5zZXRUeXBlKHRoaXMuX3R5cGUgPT09IEdyYWtuLlRyYW5zYWN0aW9uVHlwZS5SRUFEID8gVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5UeXBlLlJFQUQgOiBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlR5cGUuV1JJVEUpXG4gICAgICAgICAgICAgICAgICAgIC5zZXRPcHRpb25zKFByb3RvQnVpbGRlci5vcHRpb25zKG9wdGlvbnMpKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZXhlY3V0ZShvcGVuUmVxdWVzdCwgcmVzID0+IHJlcy5nZXRPcGVuUmVzKCkpO1xuICAgICAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgIHRoaXMuX25ldHdvcmtMYXRlbmN5TWlsbGlzID0gZW5kVGltZSAtIHN0YXJ0VGltZSAtIHJlcy5nZXRQcm9jZXNzaW5nVGltZU1pbGxpcygpO1xuICAgICAgICB0aGlzLl90cmFuc2FjdGlvbldhc09wZW5lZCA9IHRydWU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyB0eXBlKCk6IEdyYWtuLlRyYW5zYWN0aW9uVHlwZSB7XG4gICAgICAgIHJldHVybiB0aGlzLl90eXBlO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc09wZW4oKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl90cmFuc2FjdGlvbldhc09wZW5lZCAmJiAhdGhpcy5fdHJhbnNhY3Rpb25XYXNDbG9zZWQ7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbmNlcHRzKCk6IENvbmNlcHRNYW5hZ2VyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmNlcHRNYW5hZ2VyO1xuICAgIH1cblxuICAgIHB1YmxpYyBxdWVyeSgpOiBRdWVyeU1hbmFnZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fcXVlcnlNYW5hZ2VyO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBjb21taXQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGNvbW1pdFJlcSA9IG5ldyBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJlcSgpXG4gICAgICAgICAgICAuc2V0Q29tbWl0UmVxKG5ldyBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLkNvbW1pdC5SZXEoKSk7XG4gICAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZShjb21taXRSZXEpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyByb2xsYmFjaygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3Qgcm9sbGJhY2tSZXEgPSBuZXcgVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXEoKVxuICAgICAgICAgICAgLnNldFJvbGxiYWNrUmVxKG5ldyBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJvbGxiYWNrLlJlcSgpKTtcbiAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlKHJvbGxiYWNrUmVxKTtcbiAgICB9XG5cbiAgICBhc3luYyBjbG9zZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKHRoaXMuX3N0cmVhbUlzT3Blbikge1xuICAgICAgICAgICAgdGhpcy5fc3RyZWFtSXNPcGVuID0gZmFsc2U7XG4gICAgICAgICAgICAvLyBUT0RPOiBjbG9zZSBzdHJlYW0sIHNvbWVob3c/XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLl90cmFuc2FjdGlvbldhc0Nsb3NlZCkge1xuICAgICAgICAgICAgdGhpcy5fdHJhbnNhY3Rpb25XYXNDbG9zZWQgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5fY29sbGVjdG9ycy5jbGVhcldpdGhFcnJvcihuZXcgRXJyb3JSZXNwb25zZShcIlRyYW5zYWN0aW9uIGNsb3NlZC5cIikpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBleGVjdXRlPFQ+KHJlcXVlc3Q6IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVxLCB0cmFuc2Zvcm1SZXNwb25zZTogKHJlczogVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXMpID0+IFQgPSAoKSA9PiBudWxsKTogUHJvbWlzZTxUPiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlQ29sbGVjdG9yID0gbmV3IFJlc3BvbnNlQ29sbGVjdG9yKCk7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RJZCA9IHV1aWR2NCgpO1xuICAgICAgICByZXF1ZXN0LnNldElkKHJlcXVlc3RJZCk7XG4gICAgICAgIHRoaXMuX2NvbGxlY3RvcnMucHV0KHJlcXVlc3RJZCwgcmVzcG9uc2VDb2xsZWN0b3IpO1xuICAgICAgICAvLyBUT0RPOiB3ZSBjYW4gb3B0aW9uYWxseSBpbmplY3QgdGhlIGNhbGxiYWNrIGhlcmUgLSBwZXJoYXBzIHRoYXQgd291bGQgYmUgY2xlYW5lciB0aGFuIHVzaW5nIFJlc3BvbnNlQ29sbGVjdG9ycz9cbiAgICAgICAgdGhpcy5fc3RyZWFtLndyaXRlKHJlcXVlc3QpO1xuICAgICAgICByZXR1cm4gcmVzcG9uc2VDb2xsZWN0b3IudGFrZSgpLnRoZW4odHJhbnNmb3JtUmVzcG9uc2UpO1xuICAgIH1cblxuICAgIHN0cmVhbTxUPihyZXF1ZXN0OiBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJlcSwgdHJhbnNmb3JtUmVzcG9uc2U6IChyZXM6IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVzKSA9PiBUW10pOiBTdHJlYW08VD4ge1xuICAgICAgICBjb25zdCByZXNwb25zZUNvbGxlY3RvciA9IG5ldyBSZXNwb25zZUNvbGxlY3RvcigpO1xuICAgICAgICBjb25zdCByZXF1ZXN0SWQgPSB1dWlkdjQoKTtcbiAgICAgICAgcmVxdWVzdC5zZXRJZChyZXF1ZXN0SWQpO1xuICAgICAgICByZXF1ZXN0LnNldExhdGVuY3lNaWxsaXModGhpcy5fbmV0d29ya0xhdGVuY3lNaWxsaXMpO1xuICAgICAgICB0aGlzLl9jb2xsZWN0b3JzLnB1dChyZXF1ZXN0SWQsIHJlc3BvbnNlQ29sbGVjdG9yKTtcbiAgICAgICAgdGhpcy5fc3RyZWFtLndyaXRlKHJlcXVlc3QpO1xuICAgICAgICByZXR1cm4gbmV3IFN0cmVhbTxUPihyZXF1ZXN0SWQsIHRoaXMuX3N0cmVhbSwgcmVzcG9uc2VDb2xsZWN0b3IsIHRyYW5zZm9ybVJlc3BvbnNlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9wZW5UcmFuc2FjdGlvblN0cmVhbSgpIHtcbiAgICAgICAgdGhpcy5fc3RyZWFtID0gdGhpcy5fZ3JwY0NsaWVudC50cmFuc2FjdGlvbigpO1xuXG4gICAgICAgIHRoaXMuX3N0cmVhbS5vbihcImRhdGFcIiwgKHJlcykgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdElkID0gcmVzLmdldElkKCk7XG4gICAgICAgICAgICBjb25zdCBjb2xsZWN0b3IgPSB0aGlzLl9jb2xsZWN0b3JzLmdldChyZXF1ZXN0SWQpO1xuICAgICAgICAgICAgaWYgKCFjb2xsZWN0b3IpIHRocm93IFwiVW5rbm93biByZXF1ZXN0IElEIFwiICsgcmVxdWVzdElkO1xuICAgICAgICAgICAgY29sbGVjdG9yLmFkZChuZXcgT2tSZXNwb25zZShyZXMpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fc3RyZWFtLm9uKFwiZXJyb3JcIiwgKGVycikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl9zdHJlYW0ub24oXCJlbmRcIiwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fc3RyZWFtSXNPcGVuID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBUT0RPOiBsb29rIGludG8gX3N0cmVhbS5vbihzdGF0dXMpICsgYW55IG90aGVyIGV2ZW50c1xuICAgIH1cbn1cblxuY2xhc3MgUmVzcG9uc2VDb2xsZWN0b3JzIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9tYXA6IHsgW3JlcXVlc3RJZDogc3RyaW5nXTogUmVzcG9uc2VDb2xsZWN0b3IgfTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF90cmFuc2FjdGlvbjogUlBDVHJhbnNhY3Rpb247XG4gICAgY29uc3RydWN0b3IodHJhbnNhY3Rpb246IFJQQ1RyYW5zYWN0aW9uKSB7XG4gICAgICAgIHRoaXMuX21hcCA9IHt9O1xuICAgICAgICB0aGlzLl90cmFuc2FjdGlvbiA9IHRyYW5zYWN0aW9uO1xuICAgIH1cblxuICAgIGdldCh1dWlkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX21hcFt1dWlkXTtcbiAgICB9XG5cbiAgICBwdXQodXVpZDogc3RyaW5nLCBjb2xsZWN0b3I6IFJlc3BvbnNlQ29sbGVjdG9yKSB7XG4gICAgICAgIGlmICh0aGlzLl90cmFuc2FjdGlvbltcIl90cmFuc2FjdGlvbldhc0Nsb3NlZFwiXSkgdGhyb3cgXCJUaGUgdHJhbnNhY3Rpb24gaGFzIGJlZW4gY2xvc2VkIGFuZCBubyBmdXJ0aGVyIG9wZXJhdGlvbiBpcyBhbGxvd2VkLlwiXG4gICAgICAgIHRoaXMuX21hcFt1dWlkXSA9IGNvbGxlY3RvcjtcbiAgICB9XG5cbiAgICBjbGVhcldpdGhFcnJvcihlcnJvcjogRXJyb3JSZXNwb25zZSkge1xuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl9tYXApLmZvckVhY2goKHJlcXVlc3RJZCkgPT4gdGhpcy5fbWFwW3JlcXVlc3RJZF0uYWRkKGVycm9yKSk7XG4gICAgICAgIGZvciAoY29uc3QgcmVxdWVzdElkIGluIHRoaXMuX21hcCkgZGVsZXRlIHRoaXMuX21hcFtyZXF1ZXN0SWRdO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFJlc3BvbnNlQ29sbGVjdG9yIHtcbiAgICBwcml2YXRlIF9yZXNwb25zZUJ1ZmZlcjogQmxvY2tpbmdRdWV1ZTxSZXNwb25zZT47XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5fcmVzcG9uc2VCdWZmZXIgPSBuZXcgQmxvY2tpbmdRdWV1ZTxSZXNwb25zZT4oKTtcbiAgICB9XG5cbiAgICBhZGQocmVzcG9uc2U6IFJlc3BvbnNlKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3Jlc3BvbnNlQnVmZmVyLmFkZChyZXNwb25zZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgdGFrZSgpOiBQcm9taXNlPFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVzPiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5fcmVzcG9uc2VCdWZmZXIudGFrZSgpO1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVhZCgpO1xuICAgIH1cbn1cblxuYWJzdHJhY3QgY2xhc3MgUmVzcG9uc2Uge1xuICAgIGFic3RyYWN0IHJlYWQoKTogVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXM7XG59XG5cbmNsYXNzIE9rUmVzcG9uc2UgZXh0ZW5kcyBSZXNwb25zZSB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfcmVzOiBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJlcztcblxuICAgIGNvbnN0cnVjdG9yKHJlczogVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXMpIHtcbiAgICAgICAgc3VwZXIoKVxuICAgICAgICB0aGlzLl9yZXMgPSByZXM7XG4gICAgfVxuXG4gICAgcmVhZCgpOiBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJlcyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZXM7XG4gICAgfVxuXG4gICAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIFwiT2tSZXNwb25zZSB7XCIgKyB0aGlzLl9yZXMudG9TdHJpbmcoKSArIFwifVwiO1xuICAgIH1cbn1cblxuY2xhc3MgRXJyb3JSZXNwb25zZSBleHRlbmRzIFJlc3BvbnNlIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9lcnJvcjogRXJyb3IgfCBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihlcnJvcjogRXJyb3IgfCBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5fZXJyb3IgPSBlcnJvcjtcbiAgICB9XG5cbiAgICByZWFkKCk6IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVzIHtcbiAgICAgICAgdGhyb3cgdGhpcy5fZXJyb3I7XG4gICAgfVxuXG4gICAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIFwiRXJyb3JSZXNwb25zZSB7XCIgKyB0aGlzLl9lcnJvci50b1N0cmluZygpICsgXCJ9XCI7XG4gICAgfVxufVxuIl19