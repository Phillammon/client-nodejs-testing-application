/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __asyncValues = (this && this.__asyncValues) || function (o) {
    if (!Symbol.asyncIterator) throw new TypeError("Symbol.asyncIterator is not defined.");
    var m = o[Symbol.asyncIterator], i;
    return m ? m.call(o) : (o = typeof __values === "function" ? __values(o) : o[Symbol.iterator](), i = {}, verb("next"), verb("throw"), verb("return"), i[Symbol.asyncIterator] = function () { return this; }, i);
    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }
    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("grakn-client/concept/thing/impl/RelationImpl", ["require", "exports", "grakn-client/dependencies_internal", "graknlabs-grpc-protocol/protobuf/concept_pb", "graknlabs-grpc-protocol/protobuf/transaction_pb"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.RemoteRelationImpl = exports.RelationImpl = void 0;
    const dependencies_internal_1 = require("grakn-client/dependencies_internal");
    const concept_pb_1 = __importDefault(require("graknlabs-grpc-protocol/protobuf/concept_pb"));
    const transaction_pb_1 = __importDefault(require("graknlabs-grpc-protocol/protobuf/transaction_pb"));
    class RelationImpl extends dependencies_internal_1.ThingImpl {
        constructor(iid) {
            super(iid);
        }
        static of(protoThing) {
            return new RelationImpl(protoThing.getIid_asB64());
        }
        asRemote(transaction) {
            return new RemoteRelationImpl(transaction, this.getIID());
        }
    }
    exports.RelationImpl = RelationImpl;
    class RemoteRelationImpl extends dependencies_internal_1.RemoteThingImpl {
        constructor(transaction, iid) {
            super(transaction, iid);
        }
        asRemote(transaction) {
            return new RemoteRelationImpl(transaction, this.getIID());
        }
        getType() {
            return __awaiter(this, void 0, void 0, function* () {
                const res = yield this.execute(new concept_pb_1.default.Thing.Req().setThingGetTypeReq(new concept_pb_1.default.Thing.GetType.Req()));
                return dependencies_internal_1.ConceptProtoReader.thingType(res.getThingGetTypeRes().getThingType());
            });
        }
        getPlayersByRoleType() {
            var e_1, _a;
            return __awaiter(this, void 0, void 0, function* () {
                const method = new concept_pb_1.default.Thing.Req()
                    .setRelationGetPlayersByRoleTypeReq(new concept_pb_1.default.Relation.GetPlayersByRoleType.Req())
                    .setIid(this.getIID());
                const request = new transaction_pb_1.default.Transaction.Req().setThingReq(method);
                const stream = this.transaction.stream(request, res => res.getThingRes().getRelationGetPlayersByRoleTypeRes().getRoleTypeWithPlayerList());
                const rolePlayerMap = new Map();
                try {
                    for (var stream_1 = __asyncValues(stream), stream_1_1; stream_1_1 = yield stream_1.next(), !stream_1_1.done;) {
                        const rolePlayer = stream_1_1.value;
                        const role = dependencies_internal_1.ConceptProtoReader.type(rolePlayer.getRoleType());
                        const player = dependencies_internal_1.ConceptProtoReader.thing(rolePlayer.getPlayer());
                        if (!rolePlayerMap.has(role)) {
                            rolePlayerMap.set(role, []);
                        }
                        rolePlayerMap.get(role).push(player);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (stream_1_1 && !stream_1_1.done && (_a = stream_1.return)) yield _a.call(stream_1);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
                return rolePlayerMap;
            });
        }
        getPlayers(roleTypes = []) {
            const method = new concept_pb_1.default.Thing.Req().setRelationGetPlayersReq(new concept_pb_1.default.Relation.GetPlayers.Req().setRoleTypesList(roleTypes.map(roleType => dependencies_internal_1.ConceptProtoBuilder.type(roleType))));
            return this.thingStream(method, res => res.getRelationGetPlayersRes().getThingList());
        }
        addPlayer(roleType, player) {
            return __awaiter(this, void 0, void 0, function* () {
                yield this.execute(new concept_pb_1.default.Thing.Req().setRelationAddPlayerReq(new concept_pb_1.default.Relation.AddPlayer.Req()
                    .setPlayer(dependencies_internal_1.ConceptProtoBuilder.thing(player))
                    .setRoleType(dependencies_internal_1.ConceptProtoBuilder.type(roleType))));
            });
        }
        removePlayer(roleType, player) {
            return __awaiter(this, void 0, void 0, function* () {
                yield this.execute(new concept_pb_1.default.Thing.Req().setRelationRemovePlayerReq(new concept_pb_1.default.Relation.RemovePlayer.Req()
                    .setPlayer(dependencies_internal_1.ConceptProtoBuilder.thing(player))
                    .setRoleType(dependencies_internal_1.ConceptProtoBuilder.type(roleType))));
            });
        }
    }
    exports.RemoteRelationImpl = RemoteRelationImpl;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVsYXRpb25JbXBsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vY29uY2VwdC90aGluZy9pbXBsL1JlbGF0aW9uSW1wbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBRUgsOEVBYXdDO0lBRXhDLDZGQUF1RTtJQUN2RSxxR0FBK0U7SUFFL0UsTUFBYSxZQUFhLFNBQVEsaUNBQVM7UUFDdkMsWUFBc0IsR0FBVztZQUM3QixLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDZCxDQUFDO1FBRUQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxVQUE4QjtZQUNwQyxPQUFPLElBQUksWUFBWSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZELENBQUM7UUFFRCxRQUFRLENBQUMsV0FBd0I7WUFDN0IsT0FBTyxJQUFJLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUM5RCxDQUFDO0tBQ0o7SUFaRCxvQ0FZQztJQUVELE1BQWEsa0JBQW1CLFNBQVEsdUNBQWU7UUFDbkQsWUFBWSxXQUF3QixFQUFFLEdBQVc7WUFDN0MsS0FBSyxDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM1QixDQUFDO1FBRUQsUUFBUSxDQUFDLFdBQXdCO1lBQzdCLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUVLLE9BQU87O2dCQUNULE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLG9CQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLGtCQUFrQixDQUFDLElBQUksb0JBQVksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFB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RUFBRSxDQUFDLDBCQUEwQixDQUN0RSxJQUFJLG9CQUFZLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUU7cUJBQ3ZDLFNBQVMsQ0FBQywyQ0FBbUIsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7cUJBQzVDLFdBQVcsQ0FBQywyQ0FBbUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FDdkQsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztTQUFBO0tBQ0o7SUF0REQsZ0RBc0RDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbiAqIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuICogZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbiAqIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbiAqIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbiAqIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuICogc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbiAqIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4gKiBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbiAqIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7XG4gICAgVGhpbmdJbXBsLFxuICAgIFJlbW90ZVRoaW5nSW1wbCxcbiAgICBSZWxhdGlvbixcbiAgICBSZW1vdGVSZWxhdGlvbixcbiAgICBUaGluZyxcbiAgICBSZWxhdGlvblR5cGVJbXBsLFxuICAgIFJvbGVUeXBlLFxuICAgIEdyYWtuLFxuICAgIFN0cmVhbSxcbiAgICBDb25jZXB0UHJvdG9SZWFkZXIsXG4gICAgUlBDVHJhbnNhY3Rpb24sXG4gICAgUm9sZVR5cGVJbXBsLCBDb25jZXB0UHJvdG9CdWlsZGVyLFxufSBmcm9tIFwiLi4vLi4vLi4vZGVwZW5kZW5jaWVzX2ludGVybmFsXCI7XG5pbXBvcnQgVHJhbnNhY3Rpb24gPSBHcmFrbi5UcmFuc2FjdGlvbjtcbmltcG9ydCBDb25jZXB0UHJvdG8gZnJvbSBcImdyYWtubGFicy1ncnBjLXByb3RvY29sL3Byb3RvYnVmL2NvbmNlcHRfcGJcIjtcbmltcG9ydCBUcmFuc2FjdGlvblByb3RvIGZyb20gXCJncmFrbmxhYnMtZ3JwYy1wcm90b2NvbC9wcm90b2J1Zi90cmFuc2FjdGlvbl9wYlwiO1xuXG5leHBvcnQgY2xhc3MgUmVsYXRpb25JbXBsIGV4dGVuZHMgVGhpbmdJbXBsIGltcGxlbWVudHMgUmVsYXRpb24ge1xuICAgIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihpaWQ6IHN0cmluZykge1xuICAgICAgICBzdXBlcihpaWQpXG4gICAgfVxuXG4gICAgc3RhdGljIG9mKHByb3RvVGhpbmc6IENvbmNlcHRQcm90by5UaGluZyk6IFJlbGF0aW9uSW1wbCB7XG4gICAgICAgIHJldHVybiBuZXcgUmVsYXRpb25JbXBsKHByb3RvVGhpbmcuZ2V0SWlkX2FzQjY0KCkpO1xuICAgIH1cblxuICAgIGFzUmVtb3RlKHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbik6IFJlbW90ZVJlbGF0aW9uSW1wbCB7XG4gICAgICAgIHJldHVybiBuZXcgUmVtb3RlUmVsYXRpb25JbXBsKHRyYW5zYWN0aW9uLCB0aGlzLmdldElJRCgpKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZW1vdGVSZWxhdGlvbkltcGwgZXh0ZW5kcyBSZW1vdGVUaGluZ0ltcGwgaW1wbGVtZW50cyBSZW1vdGVSZWxhdGlvbiB7XG4gICAgY29uc3RydWN0b3IodHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uLCBpaWQ6IHN0cmluZykge1xuICAgICAgICBzdXBlcih0cmFuc2FjdGlvbiwgaWlkKTtcbiAgICB9XG5cbiAgICBhc1JlbW90ZSh0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb24pOiBSZW1vdGVSZWxhdGlvbkltcGwge1xuICAgICAgICByZXR1cm4gbmV3IFJlbW90ZVJlbGF0aW9uSW1wbCh0cmFuc2FjdGlvbiwgdGhpcy5nZXRJSUQoKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0VHlwZSgpOiBQcm9taXNlPFJlbGF0aW9uVHlwZUltcGw+IHtcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5leGVjdXRlKG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuUmVxKCkuc2V0VGhpbmdHZXRUeXBlUmVxKG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuR2V0VHlwZS5SZXEoKSkpO1xuICAgICAgICByZXR1cm4gQ29uY2VwdFByb3RvUmVhZGVyLnRoaW5nVHlwZShyZXMuZ2V0VGhpbmdHZXRUeXBlUmVzKCkuZ2V0VGhpbmdUeXBlKCkpIGFzIFJlbGF0aW9uVHlwZUltcGw7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0UGxheWVyc0J5Um9sZVR5cGUoKTogUHJvbWlzZTxNYXA8Um9sZVR5cGUsIFRoaW5nW10+PiB7XG4gICAgICAgIGNvbnN0IG1ldGhvZCA9IG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuUmVxKClcbiAgICAgICAgICAgIC5zZXRSZWxhdGlvbkdldFBsYXllcnNCeVJvbGVUeXBlUmVxKG5ldyBDb25jZXB0UHJvdG8uUmVsYXRpb24uR2V0UGxheWVyc0J5Um9sZVR5cGUuUmVxKCkpXG4gICAgICAgICAgICAuc2V0SWlkKHRoaXMuZ2V0SUlEKCkpO1xuICAgICAgICBjb25zdCByZXF1ZXN0ID0gbmV3IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVxKCkuc2V0VGhpbmdSZXEobWV0aG9kKTtcbiAgICAgICAgY29uc3Qgc3RyZWFtID0gKHRoaXMudHJhbnNhY3Rpb24gYXMgUlBDVHJhbnNhY3Rpb24pLnN0cmVhbShyZXF1ZXN0LCByZXMgPT4gcmVzLmdldFRoaW5nUmVzKCkuZ2V0UmVsYXRpb25HZXRQbGF5ZXJzQnlSb2xlVHlwZVJlcygpLmdldFJvbGVUeXBlV2l0aFBsYXllckxpc3QoKSlcbiAgICAgICAgY29uc3Qgcm9sZVBsYXllck1hcCA9IG5ldyBNYXA8Um9sZVR5cGVJbXBsLCBUaGluZ0ltcGxbXT4oKTtcbiAgICAgICAgZm9yIGF3YWl0IChjb25zdCByb2xlUGxheWVyIG9mIHN0cmVhbSkge1xuICAgICAgICAgICAgY29uc3Qgcm9sZSA9IENvbmNlcHRQcm90b1JlYWRlci50eXBlKHJvbGVQbGF5ZXIuZ2V0Um9sZVR5cGUoKSkgYXMgUm9sZVR5cGVJbXBsO1xuICAgICAgICAgICAgY29uc3QgcGxheWVyID0gQ29uY2VwdFByb3RvUmVhZGVyLnRoaW5nKHJvbGVQbGF5ZXIuZ2V0UGxheWVyKCkpO1xuICAgICAgICAgICAgaWYgKCFyb2xlUGxheWVyTWFwLmhhcyhyb2xlKSkge1xuICAgICAgICAgICAgICAgIHJvbGVQbGF5ZXJNYXAuc2V0KHJvbGUsIFtdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJvbGVQbGF5ZXJNYXAuZ2V0KHJvbGUpLnB1c2gocGxheWVyKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByb2xlUGxheWVyTWFwO1xuICAgIH1cblxuICAgIGdldFBsYXllcnMoKTogU3RyZWFtPFRoaW5nSW1wbD47XG4gICAgZ2V0UGxheWVycyhyb2xlVHlwZXM6IFJvbGVUeXBlW10gPSBbXSk6IFN0cmVhbTxUaGluZ0ltcGw+IHtcbiAgICAgICAgY29uc3QgbWV0aG9kID0gbmV3IENvbmNlcHRQcm90by5UaGluZy5SZXEoKS5zZXRSZWxhdGlvbkdldFBsYXllcnNSZXEoXG4gICAgICAgICAgICBuZXcgQ29uY2VwdFByb3RvLlJlbGF0aW9uLkdldFBsYXllcnMuUmVxKCkuc2V0Um9sZVR5cGVzTGlzdChyb2xlVHlwZXMubWFwKHJvbGVUeXBlID0+IENvbmNlcHRQcm90b0J1aWxkZXIudHlwZShyb2xlVHlwZSkpKSk7XG4gICAgICAgIHJldHVybiB0aGlzLnRoaW5nU3RyZWFtKG1ldGhvZCwgcmVzID0+IHJlcy5nZXRSZWxhdGlvbkdldFBsYXllcnNSZXMoKS5nZXRUaGluZ0xpc3QoKSkgYXMgU3RyZWFtPFRoaW5nSW1wbD47XG4gICAgfVxuXG4gICAgYXN5bmMgYWRkUGxheWVyKHJvbGVUeXBlOiBSb2xlVHlwZSwgcGxheWVyOiBUaGluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBhd2FpdCB0aGlzLmV4ZWN1dGUobmV3IENvbmNlcHRQcm90by5UaGluZy5SZXEoKS5zZXRSZWxhdGlvbkFkZFBsYXllclJlcShcbiAgICAgICAgICAgIG5ldyBDb25jZXB0UHJvdG8uUmVsYXRpb24uQWRkUGxheWVyLlJlcSgpXG4gICAgICAgICAgICAgICAgLnNldFBsYXllcihDb25jZXB0UHJvdG9CdWlsZGVyLnRoaW5nKHBsYXllcikpXG4gICAgICAgICAgICAgICAgLnNldFJvbGVUeXBlKENvbmNlcHRQcm90b0J1aWxkZXIudHlwZShyb2xlVHlwZSkpXG4gICAgICAgICkpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlbW92ZVBsYXllcihyb2xlVHlwZTogUm9sZVR5cGUsIHBsYXllcjogVGhpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlKG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuUmVxKCkuc2V0UmVsYXRpb25SZW1vdmVQbGF5ZXJSZXEoXG4gICAgICAgICAgICBuZXcgQ29uY2VwdFByb3RvLlJlbGF0aW9uLlJlbW92ZVBsYXllci5SZXEoKVxuICAgICAgICAgICAgICAgIC5zZXRQbGF5ZXIoQ29uY2VwdFByb3RvQnVpbGRlci50aGluZyhwbGF5ZXIpKVxuICAgICAgICAgICAgICAgIC5zZXRSb2xlVHlwZShDb25jZXB0UHJvdG9CdWlsZGVyLnR5cGUocm9sZVR5cGUpKVxuICAgICAgICApKTtcbiAgICB9XG59XG4iXX0=