/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __asyncValues = (this && this.__asyncValues) || function (o) {
    if (!Symbol.asyncIterator) throw new TypeError("Symbol.asyncIterator is not defined.");
    var m = o[Symbol.asyncIterator], i;
    return m ? m.call(o) : (o = typeof __values === "function" ? __values(o) : o[Symbol.iterator](), i = {}, verb("next"), verb("throw"), verb("return"), i[Symbol.asyncIterator] = function () { return this; }, i);
    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }
    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("grakn-client/concept/thing/impl/RelationImpl", ["require", "exports", "grakn-client/dependencies_internal", "graknlabs-protocol/protobuf/concept_pb", "graknlabs-protocol/protobuf/transaction_pb"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.RemoteRelationImpl = exports.RelationImpl = void 0;
    const dependencies_internal_1 = require("grakn-client/dependencies_internal");
    const concept_pb_1 = __importDefault(require("graknlabs-protocol/protobuf/concept_pb"));
    const transaction_pb_1 = __importDefault(require("graknlabs-protocol/protobuf/transaction_pb"));
    class RelationImpl extends dependencies_internal_1.ThingImpl {
        constructor(iid) {
            super(iid);
        }
        static of(protoThing) {
            return new RelationImpl(protoThing.getIid_asB64());
        }
        asRemote(transaction) {
            return new RemoteRelationImpl(transaction, this.getIID());
        }
    }
    exports.RelationImpl = RelationImpl;
    class RemoteRelationImpl extends dependencies_internal_1.RemoteThingImpl {
        constructor(transaction, iid) {
            super(transaction, iid);
        }
        asRemote(transaction) {
            return new RemoteRelationImpl(transaction, this.getIID());
        }
        getType() {
            return __awaiter(this, void 0, void 0, function* () {
                const res = yield this.execute(new concept_pb_1.default.Thing.Req().setThingGetTypeReq(new concept_pb_1.default.Thing.GetType.Req()));
                return dependencies_internal_1.ConceptProtoReader.thingType(res.getThingGetTypeRes().getThingType());
            });
        }
        getPlayersByRoleType() {
            var e_1, _a;
            return __awaiter(this, void 0, void 0, function* () {
                const method = new concept_pb_1.default.Thing.Req()
                    .setRelationGetPlayersByRoleTypeReq(new concept_pb_1.default.Relation.GetPlayersByRoleType.Req())
                    .setIid(this.getIID());
                const request = new transaction_pb_1.default.Transaction.Req().setThingReq(method);
                const stream = this.transaction.stream(request, res => res.getThingRes().getRelationGetPlayersByRoleTypeRes().getRoleTypeWithPlayerList());
                const rolePlayerMap = new Map();
                try {
                    for (var stream_1 = __asyncValues(stream), stream_1_1; stream_1_1 = yield stream_1.next(), !stream_1_1.done;) {
                        const rolePlayer = stream_1_1.value;
                        const role = dependencies_internal_1.ConceptProtoReader.type(rolePlayer.getRoleType());
                        const player = dependencies_internal_1.ConceptProtoReader.thing(rolePlayer.getPlayer());
                        if (!rolePlayerMap.has(role)) {
                            rolePlayerMap.set(role, []);
                        }
                        rolePlayerMap.get(role).push(player);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (stream_1_1 && !stream_1_1.done && (_a = stream_1.return)) yield _a.call(stream_1);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
                return rolePlayerMap;
            });
        }
        getPlayers(roleTypes = []) {
            const method = new concept_pb_1.default.Thing.Req().setRelationGetPlayersReq(new concept_pb_1.default.Relation.GetPlayers.Req().setRoleTypesList(roleTypes.map(roleType => dependencies_internal_1.ConceptProtoBuilder.type(roleType))));
            return this.thingStream(method, res => res.getRelationGetPlayersRes().getThingList());
        }
        addPlayer(roleType, player) {
            return __awaiter(this, void 0, void 0, function* () {
                yield this.execute(new concept_pb_1.default.Thing.Req().setRelationAddPlayerReq(new concept_pb_1.default.Relation.AddPlayer.Req()
                    .setPlayer(dependencies_internal_1.ConceptProtoBuilder.thing(player))
                    .setRoleType(dependencies_internal_1.ConceptProtoBuilder.type(roleType))));
            });
        }
        removePlayer(roleType, player) {
            return __awaiter(this, void 0, void 0, function* () {
                yield this.execute(new concept_pb_1.default.Thing.Req().setRelationRemovePlayerReq(new concept_pb_1.default.Relation.RemovePlayer.Req()
                    .setPlayer(dependencies_internal_1.ConceptProtoBuilder.thing(player))
                    .setRoleType(dependencies_internal_1.ConceptProtoBuilder.type(roleType))));
            });
        }
    }
    exports.RemoteRelationImpl = RemoteRelationImpl;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVsYXRpb25JbXBsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vY29uY2VwdC90aGluZy9pbXBsL1JlbGF0aW9uSW1wbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBRUgsOEVBYXdDO0lBRXhDLHdGQUFrRTtJQUNsRSxnR0FBMEU7SUFFMUUsTUFBYSxZQUFhLFNBQVEsaUNBQVM7UUFDdkMsWUFBc0IsR0FBVztZQUM3QixLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDZCxDQUFDO1FBRUQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxVQUE4QjtZQUNwQyxPQUFPLElBQUksWUFBWSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZELENBQUM7UUFFRCxRQUFRLENBQUMsV0FBd0I7WUFDN0IsT0FBTyxJQUFJLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUM5RCxDQUFDO0tBQ0o7SUFaRCxvQ0FZQztJQUVELE1BQWEsa0JBQW1CLFNBQVEsdUNBQWU7UUFDbkQsWUFBWSxXQUF3QixFQUFFLEdBQVc7WUFDN0MsS0FBSyxDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM1QixDQUFDO1FBRUQsUUFBUSxDQUFDLFdBQXdCO1lBQzdCLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUVLLE9BQU87O2dCQUNULE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLG9CQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLGtCQUFrQixDQUFDLElBQUksb0JBQVksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFB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RUFBRSxDQUFDLDBCQUEwQixDQUN0RSxJQUFJLG9CQUFZLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUU7cUJBQ3ZDLFNBQVMsQ0FBQywyQ0FBbUIsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7cUJBQzVDLFdBQVcsQ0FBQywyQ0FBbUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FDdkQsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztTQUFBO0tBQ0o7SUF0REQsZ0RBc0RDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbiAqIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuICogZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbiAqIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbiAqIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbiAqIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuICogc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbiAqIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4gKiBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbiAqIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7XG4gICAgVGhpbmdJbXBsLFxuICAgIFJlbW90ZVRoaW5nSW1wbCxcbiAgICBSZWxhdGlvbixcbiAgICBSZW1vdGVSZWxhdGlvbixcbiAgICBUaGluZyxcbiAgICBSZWxhdGlvblR5cGVJbXBsLFxuICAgIFJvbGVUeXBlLFxuICAgIEdyYWtuLFxuICAgIFN0cmVhbSxcbiAgICBDb25jZXB0UHJvdG9SZWFkZXIsXG4gICAgUlBDVHJhbnNhY3Rpb24sXG4gICAgUm9sZVR5cGVJbXBsLCBDb25jZXB0UHJvdG9CdWlsZGVyLFxufSBmcm9tIFwiLi4vLi4vLi4vZGVwZW5kZW5jaWVzX2ludGVybmFsXCI7XG5pbXBvcnQgVHJhbnNhY3Rpb24gPSBHcmFrbi5UcmFuc2FjdGlvbjtcbmltcG9ydCBDb25jZXB0UHJvdG8gZnJvbSBcImdyYWtubGFicy1wcm90b2NvbC9wcm90b2J1Zi9jb25jZXB0X3BiXCI7XG5pbXBvcnQgVHJhbnNhY3Rpb25Qcm90byBmcm9tIFwiZ3Jha25sYWJzLXByb3RvY29sL3Byb3RvYnVmL3RyYW5zYWN0aW9uX3BiXCI7XG5cbmV4cG9ydCBjbGFzcyBSZWxhdGlvbkltcGwgZXh0ZW5kcyBUaGluZ0ltcGwgaW1wbGVtZW50cyBSZWxhdGlvbiB7XG4gICAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKGlpZDogc3RyaW5nKSB7XG4gICAgICAgIHN1cGVyKGlpZClcbiAgICB9XG5cbiAgICBzdGF0aWMgb2YocHJvdG9UaGluZzogQ29uY2VwdFByb3RvLlRoaW5nKTogUmVsYXRpb25JbXBsIHtcbiAgICAgICAgcmV0dXJuIG5ldyBSZWxhdGlvbkltcGwocHJvdG9UaGluZy5nZXRJaWRfYXNCNjQoKSk7XG4gICAgfVxuXG4gICAgYXNSZW1vdGUodHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uKTogUmVtb3RlUmVsYXRpb25JbXBsIHtcbiAgICAgICAgcmV0dXJuIG5ldyBSZW1vdGVSZWxhdGlvbkltcGwodHJhbnNhY3Rpb24sIHRoaXMuZ2V0SUlEKCkpO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFJlbW90ZVJlbGF0aW9uSW1wbCBleHRlbmRzIFJlbW90ZVRoaW5nSW1wbCBpbXBsZW1lbnRzIFJlbW90ZVJlbGF0aW9uIHtcbiAgICBjb25zdHJ1Y3Rvcih0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb24sIGlpZDogc3RyaW5nKSB7XG4gICAgICAgIHN1cGVyKHRyYW5zYWN0aW9uLCBpaWQpO1xuICAgIH1cblxuICAgIGFzUmVtb3RlKHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbik6IFJlbW90ZVJlbGF0aW9uSW1wbCB7XG4gICAgICAgIHJldHVybiBuZXcgUmVtb3RlUmVsYXRpb25JbXBsKHRyYW5zYWN0aW9uLCB0aGlzLmdldElJRCgpKTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRUeXBlKCk6IFByb21pc2U8UmVsYXRpb25UeXBlSW1wbD4ge1xuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmV4ZWN1dGUobmV3IENvbmNlcHRQcm90by5UaGluZy5SZXEoKS5zZXRUaGluZ0dldFR5cGVSZXEobmV3IENvbmNlcHRQcm90by5UaGluZy5HZXRUeXBlLlJlcSgpKSk7XG4gICAgICAgIHJldHVybiBDb25jZXB0UHJvdG9SZWFkZXIudGhpbmdUeXBlKHJlcy5nZXRUaGluZ0dldFR5cGVSZXMoKS5nZXRUaGluZ1R5cGUoKSkgYXMgUmVsYXRpb25UeXBlSW1wbDtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRQbGF5ZXJzQnlSb2xlVHlwZSgpOiBQcm9taXNlPE1hcDxSb2xlVHlwZSwgVGhpbmdbXT4+IHtcbiAgICAgICAgY29uc3QgbWV0aG9kID0gbmV3IENvbmNlcHRQcm90by5UaGluZy5SZXEoKVxuICAgICAgICAgICAgLnNldFJlbGF0aW9uR2V0UGxheWVyc0J5Um9sZVR5cGVSZXEobmV3IENvbmNlcHRQcm90by5SZWxhdGlvbi5HZXRQbGF5ZXJzQnlSb2xlVHlwZS5SZXEoKSlcbiAgICAgICAgICAgIC5zZXRJaWQodGhpcy5nZXRJSUQoKSk7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXEoKS5zZXRUaGluZ1JlcShtZXRob2QpO1xuICAgICAgICBjb25zdCBzdHJlYW0gPSAodGhpcy50cmFuc2FjdGlvbiBhcyBSUENUcmFuc2FjdGlvbikuc3RyZWFtKHJlcXVlc3QsIHJlcyA9PiByZXMuZ2V0VGhpbmdSZXMoKS5nZXRSZWxhdGlvbkdldFBsYXllcnNCeVJvbGVUeXBlUmVzKCkuZ2V0Um9sZVR5cGVXaXRoUGxheWVyTGlzdCgpKVxuICAgICAgICBjb25zdCByb2xlUGxheWVyTWFwID0gbmV3IE1hcDxSb2xlVHlwZUltcGwsIFRoaW5nSW1wbFtdPigpO1xuICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHJvbGVQbGF5ZXIgb2Ygc3RyZWFtKSB7XG4gICAgICAgICAgICBjb25zdCByb2xlID0gQ29uY2VwdFByb3RvUmVhZGVyLnR5cGUocm9sZVBsYXllci5nZXRSb2xlVHlwZSgpKSBhcyBSb2xlVHlwZUltcGw7XG4gICAgICAgICAgICBjb25zdCBwbGF5ZXIgPSBDb25jZXB0UHJvdG9SZWFkZXIudGhpbmcocm9sZVBsYXllci5nZXRQbGF5ZXIoKSk7XG4gICAgICAgICAgICBpZiAoIXJvbGVQbGF5ZXJNYXAuaGFzKHJvbGUpKSB7XG4gICAgICAgICAgICAgICAgcm9sZVBsYXllck1hcC5zZXQocm9sZSwgW10pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcm9sZVBsYXllck1hcC5nZXQocm9sZSkucHVzaChwbGF5ZXIpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJvbGVQbGF5ZXJNYXA7XG4gICAgfVxuXG4gICAgZ2V0UGxheWVycygpOiBTdHJlYW08VGhpbmdJbXBsPjtcbiAgICBnZXRQbGF5ZXJzKHJvbGVUeXBlczogUm9sZVR5cGVbXSA9IFtdKTogU3RyZWFtPFRoaW5nSW1wbD4ge1xuICAgICAgICBjb25zdCBtZXRob2QgPSBuZXcgQ29uY2VwdFByb3RvLlRoaW5nLlJlcSgpLnNldFJlbGF0aW9uR2V0UGxheWVyc1JlcShcbiAgICAgICAgICAgIG5ldyBDb25jZXB0UHJvdG8uUmVsYXRpb24uR2V0UGxheWVycy5SZXEoKS5zZXRSb2xlVHlwZXNMaXN0KHJvbGVUeXBlcy5tYXAocm9sZVR5cGUgPT4gQ29uY2VwdFByb3RvQnVpbGRlci50eXBlKHJvbGVUeXBlKSkpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMudGhpbmdTdHJlYW0obWV0aG9kLCByZXMgPT4gcmVzLmdldFJlbGF0aW9uR2V0UGxheWVyc1JlcygpLmdldFRoaW5nTGlzdCgpKSBhcyBTdHJlYW08VGhpbmdJbXBsPjtcbiAgICB9XG5cbiAgICBhc3luYyBhZGRQbGF5ZXIocm9sZVR5cGU6IFJvbGVUeXBlLCBwbGF5ZXI6IFRoaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZShuZXcgQ29uY2VwdFByb3RvLlRoaW5nLlJlcSgpLnNldFJlbGF0aW9uQWRkUGxheWVyUmVxKFxuICAgICAgICAgICAgbmV3IENvbmNlcHRQcm90by5SZWxhdGlvbi5BZGRQbGF5ZXIuUmVxKClcbiAgICAgICAgICAgICAgICAuc2V0UGxheWVyKENvbmNlcHRQcm90b0J1aWxkZXIudGhpbmcocGxheWVyKSlcbiAgICAgICAgICAgICAgICAuc2V0Um9sZVR5cGUoQ29uY2VwdFByb3RvQnVpbGRlci50eXBlKHJvbGVUeXBlKSlcbiAgICAgICAgKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVtb3ZlUGxheWVyKHJvbGVUeXBlOiBSb2xlVHlwZSwgcGxheWVyOiBUaGluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBhd2FpdCB0aGlzLmV4ZWN1dGUobmV3IENvbmNlcHRQcm90by5UaGluZy5SZXEoKS5zZXRSZWxhdGlvblJlbW92ZVBsYXllclJlcShcbiAgICAgICAgICAgIG5ldyBDb25jZXB0UHJvdG8uUmVsYXRpb24uUmVtb3ZlUGxheWVyLlJlcSgpXG4gICAgICAgICAgICAgICAgLnNldFBsYXllcihDb25jZXB0UHJvdG9CdWlsZGVyLnRoaW5nKHBsYXllcikpXG4gICAgICAgICAgICAgICAgLnNldFJvbGVUeXBlKENvbmNlcHRQcm90b0J1aWxkZXIudHlwZShyb2xlVHlwZSkpXG4gICAgICAgICkpO1xuICAgIH1cbn1cbiJdfQ==