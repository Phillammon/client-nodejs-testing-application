/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("grakn-client/concept/thing/impl/ThingImpl", ["require", "exports", "grakn-client/dependencies_internal", "graknlabs-protocol/protobuf/concept_pb", "graknlabs-protocol/protobuf/transaction_pb"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.RemoteThingImpl = exports.ThingImpl = void 0;
    const dependencies_internal_1 = require("grakn-client/dependencies_internal");
    const concept_pb_1 = __importDefault(require("graknlabs-protocol/protobuf/concept_pb"));
    const transaction_pb_1 = __importDefault(require("graknlabs-protocol/protobuf/transaction_pb"));
    class ThingImpl {
        constructor(iid) {
            if (!iid)
                throw new dependencies_internal_1.GraknClientError(dependencies_internal_1.ErrorMessage.Concept.MISSING_IID.message());
            this._iid = iid;
        }
        getIID() {
            return this._iid;
        }
        isRemote() {
            return false;
        }
        toString() {
            return `${ThingImpl.name}[iid:${this._iid}]`;
        }
    }
    exports.ThingImpl = ThingImpl;
    class RemoteThingImpl {
        constructor(transaction, iid) {
            if (!transaction)
                throw new dependencies_internal_1.GraknClientError(dependencies_internal_1.ErrorMessage.Concept.MISSING_TRANSACTION.message());
            if (!iid)
                throw new dependencies_internal_1.GraknClientError(dependencies_internal_1.ErrorMessage.Concept.MISSING_IID.message());
            this._iid = iid;
            this._rpcTransaction = transaction;
        }
        getIID() {
            return this._iid;
        }
        getType() {
            return __awaiter(this, void 0, void 0, function* () {
                const response = yield this.execute(new concept_pb_1.default.Thing.Req().setThingGetTypeReq(new concept_pb_1.default.Thing.GetType.Req()));
                return dependencies_internal_1.ConceptProtoReader.type(response.getThingGetTypeRes().getThingType());
            });
        }
        isInferred() {
            return __awaiter(this, void 0, void 0, function* () {
                return (yield this.execute(new concept_pb_1.default.Thing.Req().setThingIsInferredReq(new concept_pb_1.default.Thing.IsInferred.Req()))).getThingIsInferredRes().getInferred();
            });
        }
        isRemote() {
            return true;
        }
        getHas(arg) {
            if (typeof arg === "undefined") {
                const method = new concept_pb_1.default.Thing.Req().setThingGetHasReq(new concept_pb_1.default.Thing.GetHas.Req());
                return this.thingStream(method, res => res.getThingGetHasRes().getAttributeList());
            }
            if (typeof arg === "boolean") {
                const method = new concept_pb_1.default.Thing.Req().setThingGetHasReq(new concept_pb_1.default.Thing.GetHas.Req().setKeysOnly(arg));
                return this.thingStream(method, res => res.getThingGetHasRes().getAttributeList());
            }
            if (Array.isArray(arg)) {
                const method = new concept_pb_1.default.Thing.Req()
                    .setThingGetHasReq(new concept_pb_1.default.Thing.GetHas.Req().setAttributeTypesList(dependencies_internal_1.ConceptProtoBuilder.types(arg)));
                return this.thingStream(method, res => res.getThingGetHasRes().getAttributeList());
            }
            const method = new concept_pb_1.default.Thing.Req()
                .setThingGetHasReq(new concept_pb_1.default.Thing.GetHas.Req().setAttributeTypesList([dependencies_internal_1.ConceptProtoBuilder.type(arg)]));
            const stream = this.thingStream(method, res => res.getThingGetHasRes().getAttributeList());
            if (arg instanceof dependencies_internal_1.BooleanAttributeTypeImpl)
                return stream;
            if (arg instanceof dependencies_internal_1.LongAttributeTypeImpl)
                return stream;
            if (arg instanceof dependencies_internal_1.DoubleAttributeTypeImpl)
                return stream;
            if (arg instanceof dependencies_internal_1.StringAttributeTypeImpl)
                return stream;
            if (arg instanceof dependencies_internal_1.DateTimeAttributeTypeImpl)
                return stream;
            throw new dependencies_internal_1.GraknClientError(dependencies_internal_1.ErrorMessage.Concept.BAD_VALUE_TYPE.message(arg));
        }
        getPlays() {
            const method = new concept_pb_1.default.Thing.Req().setThingGetPlaysReq(new concept_pb_1.default.Thing.GetPlays.Req());
            return this.typeStream(method, res => res.getThingGetPlaysRes().getRoleTypeList());
        }
        getRelations(roleTypes = []) {
            const method = new concept_pb_1.default.Thing.Req().setThingGetRelationsReq(new concept_pb_1.default.Thing.GetRelations.Req().setRoleTypesList(dependencies_internal_1.ConceptProtoBuilder.types(roleTypes)));
            return this.thingStream(method, res => res.getThingGetRelationsRes().getRelationList());
        }
        setHas(attribute) {
            return __awaiter(this, void 0, void 0, function* () {
                yield this.execute(new concept_pb_1.default.Thing.Req().setThingSetHasReq(new concept_pb_1.default.Thing.SetHas.Req().setAttribute(dependencies_internal_1.ConceptProtoBuilder.thing(attribute))));
            });
        }
        unsetHas(attribute) {
            return __awaiter(this, void 0, void 0, function* () {
                yield this.execute(new concept_pb_1.default.Thing.Req().setThingUnsetHasReq(new concept_pb_1.default.Thing.UnsetHas.Req().setAttribute(dependencies_internal_1.ConceptProtoBuilder.thing(attribute))));
            });
        }
        delete() {
            return __awaiter(this, void 0, void 0, function* () {
                yield this.execute(new concept_pb_1.default.Thing.Req().setThingDeleteReq(new concept_pb_1.default.Thing.Delete.Req()));
            });
        }
        isDeleted() {
            return __awaiter(this, void 0, void 0, function* () {
                return !(yield this._rpcTransaction.concepts().getThing(this._iid));
            });
        }
        get transaction() {
            return this._rpcTransaction;
        }
        typeStream(method, typeGetter) {
            const request = new transaction_pb_1.default.Transaction.Req().setThingReq(method.setIid(this._iid));
            return (this._rpcTransaction).stream(request, res => typeGetter(res.getThingRes()).map(dependencies_internal_1.ConceptProtoReader.type));
        }
        thingStream(method, thingGetter) {
            const request = new transaction_pb_1.default.Transaction.Req().setThingReq(method.setIid(this._iid));
            return this._rpcTransaction.stream(request, res => thingGetter(res.getThingRes()).map(dependencies_internal_1.ConceptProtoReader.thing));
        }
        execute(method) {
            const request = new transaction_pb_1.default.Transaction.Req().setThingReq(method.setIid(this._iid));
            return this._rpcTransaction.execute(request, res => res.getThingRes());
        }
        toString() {
            return `${RemoteThingImpl.name}[iid:${this._iid}]`;
        }
    }
    exports.RemoteThingImpl = RemoteThingImpl;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGhpbmdJbXBsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vY29uY2VwdC90aGluZy9pbXBsL1RoaW5nSW1wbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFFSCw4RUFrQ3dDO0lBQ3hDLHdGQUFrRTtJQUVsRSxnR0FBMEU7SUFHMUUsTUFBc0IsU0FBUztRQUczQixZQUFzQixHQUFXO1lBQzdCLElBQUksQ0FBQyxHQUFHO2dCQUFFLE1BQU0sSUFBSSx3Q0FBZ0IsQ0FBQyxvQ0FBWSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUNqRixJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQztRQUNwQixDQUFDO1FBRUQsTUFBTTtZQUNGLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztRQUNyQixDQUFDO1FBRUQsUUFBUTtZQUNKLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUM7UUFFRCxRQUFRO1lBQ0osT0FBTyxHQUFHLFNBQVMsQ0FBQyxJQUFJLFFBQVEsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDO1FBQ2pELENBQUM7S0FHSjtJQXJCRCw4QkFxQkM7SUFFRCxNQUFzQixlQUFlO1FBSWpDLFlBQXNCLFdBQXdCLEVBQUUsR0FBVztZQUN2RCxJQUFJLENBQUMsV0FBVztnQkFBRSxNQUFNLElBQUksd0NBQWdCLENBQUMsb0NBQVksQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUNqRyxJQUFJLENBQUMsR0FBRztnQkFBRSxNQUFNLElBQUksd0NBQWdCLENBQUMsb0NBQVksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFDakYsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUM7WUFDaEIsSUFBSSxDQUFDLGVB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RUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQzNFLENBQUM7UUFFRCxRQUFRO1lBQ0osT0FBTyxHQUFHLGVBQWUsQ0FBQyxJQUFJLFFBQVEsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDO1FBQ3ZELENBQUM7S0FHSjtJQXJIRCwwQ0FxSEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0aW9uIChBU0YpIHVuZGVyIG9uZVxuICogb3IgbW9yZSBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlXG4gKiBkaXN0cmlidXRlZCB3aXRoIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvblxuICogcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZVxuICogdG8geW91IHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZVxuICogXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4gKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuICogXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbiAqIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuICogc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuICogdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHtcbiAgICBUaGluZyxcbiAgICBSZW1vdGVUaGluZyxcbiAgICBBdHRyaWJ1dGUsXG4gICAgVHlwZSxcbiAgICBBdHRyaWJ1dGVUeXBlLFxuICAgIEJvb2xlYW5BdHRyaWJ1dGVUeXBlLFxuICAgIERhdGVUaW1lQXR0cmlidXRlVHlwZSxcbiAgICBEb3VibGVBdHRyaWJ1dGVUeXBlLFxuICAgIExvbmdBdHRyaWJ1dGVUeXBlLFxuICAgIFN0cmluZ0F0dHJpYnV0ZVR5cGUsXG4gICAgUm9sZVR5cGUsXG4gICAgR3Jha24sXG4gICAgVGhpbmdUeXBlSW1wbCxcbiAgICBSb2xlVHlwZUltcGwsXG4gICAgU3RyZWFtLFxuICAgIFJlbGF0aW9uSW1wbCxcbiAgICBUeXBlSW1wbCxcbiAgICBDb25jZXB0UHJvdG9SZWFkZXIsXG4gICAgQ29uY2VwdFByb3RvQnVpbGRlcixcbiAgICBSUENUcmFuc2FjdGlvbixcbiAgICBCb29sZWFuQXR0cmlidXRlVHlwZUltcGwsXG4gICAgRGF0ZVRpbWVBdHRyaWJ1dGVUeXBlSW1wbCxcbiAgICBEb3VibGVBdHRyaWJ1dGVUeXBlSW1wbCxcbiAgICBTdHJpbmdBdHRyaWJ1dGVUeXBlSW1wbCxcbiAgICBMb25nQXR0cmlidXRlVHlwZUltcGwsXG4gICAgQXR0cmlidXRlSW1wbCxcbiAgICBCb29sZWFuQXR0cmlidXRlSW1wbCxcbiAgICBEYXRlVGltZUF0dHJpYnV0ZUltcGwsXG4gICAgRG91YmxlQXR0cmlidXRlSW1wbCxcbiAgICBMb25nQXR0cmlidXRlSW1wbCxcbiAgICBTdHJpbmdBdHRyaWJ1dGVJbXBsLFxuICAgIEdyYWtuQ2xpZW50RXJyb3IsXG4gICAgRXJyb3JNZXNzYWdlLFxufSBmcm9tIFwiLi4vLi4vLi4vZGVwZW5kZW5jaWVzX2ludGVybmFsXCI7XG5pbXBvcnQgQ29uY2VwdFByb3RvIGZyb20gXCJncmFrbmxhYnMtcHJvdG9jb2wvcHJvdG9idWYvY29uY2VwdF9wYlwiO1xuaW1wb3J0IFRyYW5zYWN0aW9uID0gR3Jha24uVHJhbnNhY3Rpb247XG5pbXBvcnQgVHJhbnNhY3Rpb25Qcm90byBmcm9tIFwiZ3Jha25sYWJzLXByb3RvY29sL3Byb3RvYnVmL3RyYW5zYWN0aW9uX3BiXCI7XG5pbXBvcnQgVmFsdWVDbGFzcyA9IEF0dHJpYnV0ZVR5cGUuVmFsdWVDbGFzcztcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFRoaW5nSW1wbCBpbXBsZW1lbnRzIFRoaW5nIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9paWQ6IHN0cmluZztcblxuICAgIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihpaWQ6IHN0cmluZykge1xuICAgICAgICBpZiAoIWlpZCkgdGhyb3cgbmV3IEdyYWtuQ2xpZW50RXJyb3IoRXJyb3JNZXNzYWdlLkNvbmNlcHQuTUlTU0lOR19JSUQubWVzc2FnZSgpKTtcbiAgICAgICAgdGhpcy5faWlkID0gaWlkO1xuICAgIH1cblxuICAgIGdldElJRCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5faWlkO1xuICAgIH1cblxuICAgIGlzUmVtb3RlKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGAke1RoaW5nSW1wbC5uYW1lfVtpaWQ6JHt0aGlzLl9paWR9XWA7XG4gICAgfVxuXG4gICAgYWJzdHJhY3QgYXNSZW1vdGUodHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uKTogUmVtb3RlVGhpbmc7XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBSZW1vdGVUaGluZ0ltcGwgaW1wbGVtZW50cyBSZW1vdGVUaGluZyB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfaWlkOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfcnBjVHJhbnNhY3Rpb246IFJQQ1RyYW5zYWN0aW9uO1xuXG4gICAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbiwgaWlkOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCF0cmFuc2FjdGlvbikgdGhyb3cgbmV3IEdyYWtuQ2xpZW50RXJyb3IoRXJyb3JNZXNzYWdlLkNvbmNlcHQuTUlTU0lOR19UUkFOU0FDVElPTi5tZXNzYWdlKCkpO1xuICAgICAgICBpZiAoIWlpZCkgdGhyb3cgbmV3IEdyYWtuQ2xpZW50RXJyb3IoRXJyb3JNZXNzYWdlLkNvbmNlcHQuTUlTU0lOR19JSUQubWVzc2FnZSgpKTtcbiAgICAgICAgdGhpcy5faWlkID0gaWlkO1xuICAgICAgICB0aGlzLl9ycGNUcmFuc2FjdGlvbiA9IHRyYW5zYWN0aW9uIGFzIFJQQ1RyYW5zYWN0aW9uO1xuICAgIH1cblxuICAgIGdldElJRCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5faWlkO1xuICAgIH1cblxuICAgIGFzeW5jIGdldFR5cGUoKTogUHJvbWlzZTxUaGluZ1R5cGVJbXBsPiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5leGVjdXRlKG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuUmVxKCkuc2V0VGhpbmdHZXRUeXBlUmVxKG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuR2V0VHlwZS5SZXEoKSkpO1xuICAgICAgICByZXR1cm4gQ29uY2VwdFByb3RvUmVhZGVyLnR5cGUocmVzcG9uc2UuZ2V0VGhpbmdHZXRUeXBlUmVzKCkuZ2V0VGhpbmdUeXBlKCkpIGFzIFRoaW5nVHlwZUltcGw7XG4gICAgfVxuXG4gICAgYXN5bmMgaXNJbmZlcnJlZCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIChhd2FpdCB0aGlzLmV4ZWN1dGUobmV3IENvbmNlcHRQcm90by5UaGluZy5SZXEoKS5zZXRUaGluZ0lzSW5mZXJyZWRSZXEoXG4gICAgICAgICAgICBuZXcgQ29uY2VwdFByb3RvLlRoaW5nLklzSW5mZXJyZWQuUmVxKCkpKSkuZ2V0VGhpbmdJc0luZmVycmVkUmVzKCkuZ2V0SW5mZXJyZWQoKTtcbiAgICB9XG5cbiAgICBpc1JlbW90ZSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgZ2V0SGFzKG9ubHlLZXk6IGJvb2xlYW4pOiBTdHJlYW08QXR0cmlidXRlSW1wbDxWYWx1ZUNsYXNzPj47XG4gICAgZ2V0SGFzKGF0dHJpYnV0ZVR5cGU6IEJvb2xlYW5BdHRyaWJ1dGVUeXBlKTogU3RyZWFtPEJvb2xlYW5BdHRyaWJ1dGVJbXBsPjtcbiAgICBnZXRIYXMoYXR0cmlidXRlVHlwZTogTG9uZ0F0dHJpYnV0ZVR5cGUpOiBTdHJlYW08TG9uZ0F0dHJpYnV0ZUltcGw+O1xuICAgIGdldEhhcyhhdHRyaWJ1dGVUeXBlOiBEb3VibGVBdHRyaWJ1dGVUeXBlKTogU3RyZWFtPERvdWJsZUF0dHJpYnV0ZUltcGw+O1xuICAgIGdldEhhcyhhdHRyaWJ1dGVUeXBlOiBTdHJpbmdBdHRyaWJ1dGVUeXBlKTogU3RyZWFtPFN0cmluZ0F0dHJpYnV0ZUltcGw+O1xuICAgIGdldEhhcyhhdHRyaWJ1dGVUeXBlOiBEYXRlVGltZUF0dHJpYnV0ZVR5cGUpOiBTdHJlYW08RGF0ZVRpbWVBdHRyaWJ1dGVJbXBsPjtcbiAgICBnZXRIYXMoYXR0cmlidXRlVHlwZXM6IEF0dHJpYnV0ZVR5cGVbXSk6IFN0cmVhbTxBdHRyaWJ1dGVJbXBsPFZhbHVlQ2xhc3M+PjtcbiAgICBnZXRIYXMoKTogU3RyZWFtPEF0dHJpYnV0ZUltcGw8VmFsdWVDbGFzcz4+O1xuICAgIGdldEhhcyhhcmc/OiBib29sZWFuIHwgVHlwZSB8IEF0dHJpYnV0ZVR5cGVbXSk6IFN0cmVhbTxBdHRyaWJ1dGVJbXBsPFZhbHVlQ2xhc3M+PiB8IFN0cmVhbTxCb29sZWFuQXR0cmlidXRlSW1wbD4gfCBTdHJlYW08TG9uZ0F0dHJpYnV0ZUltcGw+XG4gICAgICAgIHwgU3RyZWFtPERvdWJsZUF0dHJpYnV0ZUltcGw+IHwgU3RyZWFtPFN0cmluZ0F0dHJpYnV0ZUltcGw+IHwgU3RyZWFtPERhdGVUaW1lQXR0cmlidXRlSW1wbD4ge1xuICAgICAgICBpZiAodHlwZW9mIGFyZyA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICAgICAgY29uc3QgbWV0aG9kID0gbmV3IENvbmNlcHRQcm90by5UaGluZy5SZXEoKS5zZXRUaGluZ0dldEhhc1JlcShuZXcgQ29uY2VwdFByb3RvLlRoaW5nLkdldEhhcy5SZXEoKSk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50aGluZ1N0cmVhbShtZXRob2QsIHJlcyA9PiByZXMuZ2V0VGhpbmdHZXRIYXNSZXMoKS5nZXRBdHRyaWJ1dGVMaXN0KCkpIGFzIFN0cmVhbTxBdHRyaWJ1dGVJbXBsPFZhbHVlQ2xhc3M+PjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIGFyZyA9PT0gXCJib29sZWFuXCIpIHtcbiAgICAgICAgICAgIGNvbnN0IG1ldGhvZCA9IG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuUmVxKCkuc2V0VGhpbmdHZXRIYXNSZXEobmV3IENvbmNlcHRQcm90by5UaGluZy5HZXRIYXMuUmVxKCkuc2V0S2V5c09ubHkoYXJnKSk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50aGluZ1N0cmVhbShtZXRob2QsIHJlcyA9PiByZXMuZ2V0VGhpbmdHZXRIYXNSZXMoKS5nZXRBdHRyaWJ1dGVMaXN0KCkpIGFzIFN0cmVhbTxBdHRyaWJ1dGVJbXBsPFZhbHVlQ2xhc3M+PjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcmcpKSB7XG4gICAgICAgICAgICBjb25zdCBtZXRob2QgPSBuZXcgQ29uY2VwdFByb3RvLlRoaW5nLlJlcSgpXG4gICAgICAgICAgICAgICAgLnNldFRoaW5nR2V0SGFzUmVxKG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuR2V0SGFzLlJlcSgpLnNldEF0dHJpYnV0ZVR5cGVzTGlzdChDb25jZXB0UHJvdG9CdWlsZGVyLnR5cGVzKGFyZykpKTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRoaW5nU3RyZWFtKG1ldGhvZCwgcmVzID0+IHJlcy5nZXRUaGluZ0dldEhhc1JlcygpLmdldEF0dHJpYnV0ZUxpc3QoKSkgYXMgU3RyZWFtPEF0dHJpYnV0ZUltcGw8VmFsdWVDbGFzcz4+O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG1ldGhvZCA9IG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuUmVxKClcbiAgICAgICAgICAgIC5zZXRUaGluZ0dldEhhc1JlcShuZXcgQ29uY2VwdFByb3RvLlRoaW5nLkdldEhhcy5SZXEoKS5zZXRBdHRyaWJ1dGVUeXBlc0xpc3QoW0NvbmNlcHRQcm90b0J1aWxkZXIudHlwZShhcmcpXSkpO1xuICAgICAgICBjb25zdCBzdHJlYW0gPSB0aGlzLnRoaW5nU3RyZWFtKG1ldGhvZCwgcmVzID0+IHJlcy5nZXRUaGluZ0dldEhhc1JlcygpLmdldEF0dHJpYnV0ZUxpc3QoKSk7XG4gICAgICAgIGlmIChhcmcgaW5zdGFuY2VvZiBCb29sZWFuQXR0cmlidXRlVHlwZUltcGwpIHJldHVybiBzdHJlYW0gYXMgU3RyZWFtPEJvb2xlYW5BdHRyaWJ1dGVJbXBsPjtcbiAgICAgICAgaWYgKGFyZyBpbnN0YW5jZW9mIExvbmdBdHRyaWJ1dGVUeXBlSW1wbCkgcmV0dXJuIHN0cmVhbSBhcyBTdHJlYW08TG9uZ0F0dHJpYnV0ZUltcGw+O1xuICAgICAgICBpZiAoYXJnIGluc3RhbmNlb2YgRG91YmxlQXR0cmlidXRlVHlwZUltcGwpIHJldHVybiBzdHJlYW0gYXMgU3RyZWFtPERvdWJsZUF0dHJpYnV0ZUltcGw+O1xuICAgICAgICBpZiAoYXJnIGluc3RhbmNlb2YgU3RyaW5nQXR0cmlidXRlVHlwZUltcGwpIHJldHVybiBzdHJlYW0gYXMgU3RyZWFtPFN0cmluZ0F0dHJpYnV0ZUltcGw+O1xuICAgICAgICBpZiAoYXJnIGluc3RhbmNlb2YgRGF0ZVRpbWVBdHRyaWJ1dGVUeXBlSW1wbCkgcmV0dXJuIHN0cmVhbSBhcyBTdHJlYW08RGF0ZVRpbWVBdHRyaWJ1dGVJbXBsPjtcbiAgICAgICAgdGhyb3cgbmV3IEdyYWtuQ2xpZW50RXJyb3IoRXJyb3JNZXNzYWdlLkNvbmNlcHQuQkFEX1ZBTFVFX1RZUEUubWVzc2FnZShhcmcpKVxuICAgIH1cblxuICAgIGdldFBsYXlzKCk6IFN0cmVhbTxSb2xlVHlwZUltcGw+IHtcbiAgICAgICAgY29uc3QgbWV0aG9kID0gbmV3IENvbmNlcHRQcm90by5UaGluZy5SZXEoKS5zZXRUaGluZ0dldFBsYXlzUmVxKG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuR2V0UGxheXMuUmVxKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy50eXBlU3RyZWFtKG1ldGhvZCwgcmVzID0+IHJlcy5nZXRUaGluZ0dldFBsYXlzUmVzKCkuZ2V0Um9sZVR5cGVMaXN0KCkpIGFzIFN0cmVhbTxSb2xlVHlwZUltcGw+O1xuICAgIH1cblxuICAgIGdldFJlbGF0aW9ucygpOiBTdHJlYW08UmVsYXRpb25JbXBsPjtcbiAgICBnZXRSZWxhdGlvbnMocm9sZVR5cGVzOiBSb2xlVHlwZVtdID0gW10pOiBTdHJlYW08UmVsYXRpb25JbXBsPiB7XG4gICAgICAgIGNvbnN0IG1ldGhvZCA9IG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuUmVxKCkuc2V0VGhpbmdHZXRSZWxhdGlvbnNSZXEoXG4gICAgICAgICAgICBuZXcgQ29uY2VwdFByb3RvLlRoaW5nLkdldFJlbGF0aW9ucy5SZXEoKS5zZXRSb2xlVHlwZXNMaXN0KENvbmNlcHRQcm90b0J1aWxkZXIudHlwZXMocm9sZVR5cGVzKSkpO1xuICAgICAgICByZXR1cm4gdGhpcy50aGluZ1N0cmVhbShtZXRob2QsIHJlcyA9PiByZXMuZ2V0VGhpbmdHZXRSZWxhdGlvbnNSZXMoKS5nZXRSZWxhdGlvbkxpc3QoKSkgYXMgU3RyZWFtPFJlbGF0aW9uSW1wbD47XG4gICAgfVxuXG4gICAgYXN5bmMgc2V0SGFzKGF0dHJpYnV0ZTogQXR0cmlidXRlPEF0dHJpYnV0ZVR5cGUuVmFsdWVDbGFzcz4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlKG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuUmVxKCkuc2V0VGhpbmdTZXRIYXNSZXEoXG4gICAgICAgICAgICBuZXcgQ29uY2VwdFByb3RvLlRoaW5nLlNldEhhcy5SZXEoKS5zZXRBdHRyaWJ1dGUoQ29uY2VwdFByb3RvQnVpbGRlci50aGluZyhhdHRyaWJ1dGUpKSkpO1xuICAgIH1cblxuICAgIGFzeW5jIHVuc2V0SGFzKGF0dHJpYnV0ZTogQXR0cmlidXRlPEF0dHJpYnV0ZVR5cGUuVmFsdWVDbGFzcz4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlKG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuUmVxKCkuc2V0VGhpbmdVbnNldEhhc1JlcShcbiAgICAgICAgICAgIG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuVW5zZXRIYXMuUmVxKCkuc2V0QXR0cmlidXRlKENvbmNlcHRQcm90b0J1aWxkZXIudGhpbmcoYXR0cmlidXRlKSkpKTtcbiAgICB9XG5cbiAgICBhc3luYyBkZWxldGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZShuZXcgQ29uY2VwdFByb3RvLlRoaW5nLlJlcSgpLnNldFRoaW5nRGVsZXRlUmVxKG5ldyBDb25jZXB0UHJvdG8uVGhpbmcuRGVsZXRlLlJlcSgpKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgaXNEZWxldGVkKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gIShhd2FpdCB0aGlzLl9ycGNUcmFuc2FjdGlvbi5jb25jZXB0cygpLmdldFRoaW5nKHRoaXMuX2lpZCkpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXQgdHJhbnNhY3Rpb24oKTogVHJhbnNhY3Rpb24ge1xuICAgICAgICByZXR1cm4gdGhpcy5fcnBjVHJhbnNhY3Rpb247XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHR5cGVTdHJlYW0obWV0aG9kOiBDb25jZXB0UHJvdG8uVGhpbmcuUmVxLCB0eXBlR2V0dGVyOiAocmVzOiBDb25jZXB0UHJvdG8uVGhpbmcuUmVzKSA9PiBDb25jZXB0UHJvdG8uVHlwZVtdKTogU3RyZWFtPFR5cGVJbXBsPiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXEoKS5zZXRUaGluZ1JlcShtZXRob2Quc2V0SWlkKHRoaXMuX2lpZCkpO1xuICAgICAgICByZXR1cm4gKHRoaXMuX3JwY1RyYW5zYWN0aW9uKS5zdHJlYW0ocmVxdWVzdCwgcmVzID0+IHR5cGVHZXR0ZXIocmVzLmdldFRoaW5nUmVzKCkpLm1hcChDb25jZXB0UHJvdG9SZWFkZXIudHlwZSkpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCB0aGluZ1N0cmVhbShtZXRob2Q6IENvbmNlcHRQcm90by5UaGluZy5SZXEsIHRoaW5nR2V0dGVyOiAocmVzOiBDb25jZXB0UHJvdG8uVGhpbmcuUmVzKSA9PiBDb25jZXB0UHJvdG8uVGhpbmdbXSk6IFN0cmVhbTxUaGluZ0ltcGw+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJlcSgpLnNldFRoaW5nUmVxKG1ldGhvZC5zZXRJaWQodGhpcy5faWlkKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9ycGNUcmFuc2FjdGlvbi5zdHJlYW0ocmVxdWVzdCwgcmVzID0+IHRoaW5nR2V0dGVyKHJlcy5nZXRUaGluZ1JlcygpKS5tYXAoQ29uY2VwdFByb3RvUmVhZGVyLnRoaW5nKSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGV4ZWN1dGUobWV0aG9kOiBDb25jZXB0UHJvdG8uVGhpbmcuUmVxKTogUHJvbWlzZTxDb25jZXB0UHJvdG8uVGhpbmcuUmVzPiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgVHJhbnNhY3Rpb25Qcm90by5UcmFuc2FjdGlvbi5SZXEoKS5zZXRUaGluZ1JlcShtZXRob2Quc2V0SWlkKHRoaXMuX2lpZCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5fcnBjVHJhbnNhY3Rpb24uZXhlY3V0ZShyZXF1ZXN0LCByZXMgPT4gcmVzLmdldFRoaW5nUmVzKCkpO1xuICAgIH1cblxuICAgIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBgJHtSZW1vdGVUaGluZ0ltcGwubmFtZX1baWlkOiR7dGhpcy5faWlkfV1gO1xuICAgIH1cblxuICAgIGFic3RyYWN0IGFzUmVtb3RlKHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbik6IFJlbW90ZVRoaW5nO1xufVxuIl19