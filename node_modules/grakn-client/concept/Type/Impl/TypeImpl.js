/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("grakn-client/concept/type/impl/TypeImpl", ["require", "exports", "grakn-client/dependencies_internal", "graknlabs-protocol/protobuf/concept_pb", "graknlabs-protocol/protobuf/transaction_pb"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.RemoteTypeImpl = exports.TypeImpl = void 0;
    const dependencies_internal_1 = require("grakn-client/dependencies_internal");
    const concept_pb_1 = __importDefault(require("graknlabs-protocol/protobuf/concept_pb"));
    const transaction_pb_1 = __importDefault(require("graknlabs-protocol/protobuf/transaction_pb"));
    class TypeImpl {
        constructor(label, root) {
            if (!label)
                throw new dependencies_internal_1.GraknClientError(dependencies_internal_1.ErrorMessage.Concept.MISSING_LABEL.message());
            this._label = label;
            this._root = root;
        }
        getLabel() {
            return this._label;
        }
        isRoot() {
            return this._root;
        }
        isRemote() {
            return false;
        }
        toString() {
            return `${this.constructor.name}[label:${this._label}]`;
        }
    }
    exports.TypeImpl = TypeImpl;
    class RemoteTypeImpl {
        constructor(transaction, label, isRoot) {
            if (!transaction)
                throw new dependencies_internal_1.GraknClientError(dependencies_internal_1.ErrorMessage.Concept.MISSING_TRANSACTION.message());
            if (!label)
                throw new dependencies_internal_1.GraknClientError(dependencies_internal_1.ErrorMessage.Concept.MISSING_LABEL.message());
            this._rpcTransaction = transaction;
            this._label = label;
            this._isRoot = isRoot;
        }
        getLabel() {
            return this._label;
        }
        isRoot() {
            return this._isRoot;
        }
        isRemote() {
            return true;
        }
        setLabel(label) {
            return __awaiter(this, void 0, void 0, function* () {
                yield this.execute(new concept_pb_1.default.Type.Req()
                    .setTypeSetLabelReq(new concept_pb_1.default.Type.SetLabel.Req().setLabel(label)));
                this._label = label;
            });
        }
        isAbstract() {
            return __awaiter(this, void 0, void 0, function* () {
                return (yield this.execute(new concept_pb_1.default.Type.Req()
                    .setTypeIsAbstractReq(new concept_pb_1.default.Type.IsAbstract.Req())))
                    .getTypeIsAbstractRes().getAbstract();
            });
        }
        setSupertype(type) {
            return __awaiter(this, void 0, void 0, function* () {
                yield this.execute(new concept_pb_1.default.Type.Req()
                    .setTypeSetSupertypeReq(new concept_pb_1.default.Type.SetSupertype.Req().setType(dependencies_internal_1.ConceptProtoBuilder.type(type))));
            });
        }
        getSupertype() {
            return __awaiter(this, void 0, void 0, function* () {
                const response = (yield this.execute(new concept_pb_1.default.Type.Req()
                    .setTypeGetSupertypeReq(new concept_pb_1.default.Type.GetSupertype.Req())))
                    .getTypeGetSupertypeRes();
                return response.getResCase() === concept_pb_1.default.Type.GetSupertype.Res.ResCase.TYPE ? dependencies_internal_1.ConceptProtoReader.type(response.getType()) : null;
            });
        }
        getSupertypes() {
            const method = new concept_pb_1.default.Type.Req().setTypeGetSupertypesReq(new concept_pb_1.default.Type.GetSupertypes.Req());
            return this.typeStream(method, res => res.getTypeGetSupertypesRes().getTypeList());
        }
        getSubtypes() {
            const method = new concept_pb_1.default.Type.Req().setTypeGetSubtypesReq(new concept_pb_1.default.Type.GetSubtypes.Req());
            return this.typeStream(method, res => res.getTypeGetSubtypesRes().getTypeList());
        }
        delete() {
            return __awaiter(this, void 0, void 0, function* () {
                yield this.execute(new concept_pb_1.default.Type.Req().setTypeDeleteReq(new concept_pb_1.default.Type.Delete.Req()));
            });
        }
        isDeleted() {
            return __awaiter(this, void 0, void 0, function* () {
                return !(yield this._rpcTransaction.concepts().getType(this._label));
            });
        }
        get transaction() {
            return this._rpcTransaction;
        }
        typeStream(method, typeGetter) {
            const request = new transaction_pb_1.default.Transaction.Req().setTypeReq(method.setLabel(this._label));
            return this._rpcTransaction.stream(request, res => typeGetter(res.getTypeRes()).map(dependencies_internal_1.ConceptProtoReader.type));
        }
        thingStream(method, thingGetter) {
            const request = new transaction_pb_1.default.Transaction.Req().setTypeReq(method.setLabel(this._label));
            return this._rpcTransaction.stream(request, res => thingGetter(res.getTypeRes()).map(dependencies_internal_1.ConceptProtoReader.thing));
        }
        execute(method) {
            const request = new transaction_pb_1.default.Transaction.Req().setTypeReq(method.setLabel(this._label));
            return this._rpcTransaction.execute(request, res => res.getTypeRes());
        }
        toString() {
            return `${this.constructor.name}[label:${this._label}]`;
        }
    }
    exports.RemoteTypeImpl = RemoteTypeImpl;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHlwZUltcGwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9jb25jZXB0L3R5cGUvaW1wbC9UeXBlSW1wbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFFSCw4RUFXd0M7SUFDeEMsd0ZBQWtFO0lBQ2xFLGdHQUEwRTtJQUcxRSxNQUFzQixRQUFRO1FBSTFCLFlBQXNCLEtBQWEsRUFBRSxJQUFhO1lBQzlDLElBQUksQ0FBQyxLQUFLO2dCQUFFLE1BQU0sSUFBSSx3Q0FBZ0IsQ0FBQyxvQ0FBWSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUVyRixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztZQUNwQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUN0QixDQUFDO1FBRUQsUUFBUTtZQUNKLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUN2QixDQUFDO1FBRUQsTUFBTTtZQUNGLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN0QixDQUFDO1FBRUQsUUFBUTtZQUNKLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUM7UUFFRCxRQUFRO1lBQ0osT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxVQUFVLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQztRQUM1RCxDQUFDO0tBR0o7SUE1QkQsNEJBNEJDO0lBRUQsTUFBc0IsY0FBYztRQUtoQyxZQUFzQixXQUF3QixFQUFFLEtBQWEsRUFBRSxNQUFlO1lBQzFFLElBQUksQ0FBQyxXQUFXO2dCQUFFLE1BQU0sSUFBSSx3Q0FBZ0IsQ0FBQyxvQ0FBWSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQ2pHLElBQUksQ0FBQyxLQUFLO2dCQUFFLE1BQU0sSUFBSSx3Q0FB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R0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDaEcsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLDBDQUFrQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDcEgsQ0FBQztRQUVTLE9BQU8sQ0FBQyxNQUE2QjtZQUMzQyxNQUFNLE9BQU8sR0FBRyxJQUFJLHdCQUFnQixDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNoRyxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBQzFFLENBQUM7UUFFRCxRQUFRO1lBQ0osT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxVQUFVLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQztRQUM1RCxDQUFDO0tBR0o7SUE1RkQsd0NBNEZDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmVcbiAqIG9yIG1vcmUgY29udHJpYnV0b3IgbGljZW5zZSBhZ3JlZW1lbnRzLiAgU2VlIHRoZSBOT1RJQ0UgZmlsZVxuICogZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cbiAqIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLiAgVGhlIEFTRiBsaWNlbnNlcyB0aGlzIGZpbGVcbiAqIHRvIHlvdSB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGVcbiAqIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuICogc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbiAqIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4gKiBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbiAqIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7XG4gICAgUmVtb3RlVHlwZSxcbiAgICBUeXBlLFxuICAgIEdyYWtuLFxuICAgIFJQQ1RyYW5zYWN0aW9uLFxuICAgIFN0cmVhbSxcbiAgICBUaGluZ0ltcGwsXG4gICAgQ29uY2VwdFByb3RvQnVpbGRlcixcbiAgICBDb25jZXB0UHJvdG9SZWFkZXIsXG4gICAgR3Jha25DbGllbnRFcnJvcixcbiAgICBFcnJvck1lc3NhZ2UsXG59IGZyb20gXCIuLi8uLi8uLi9kZXBlbmRlbmNpZXNfaW50ZXJuYWxcIjtcbmltcG9ydCBDb25jZXB0UHJvdG8gZnJvbSBcImdyYWtubGFicy1wcm90b2NvbC9wcm90b2J1Zi9jb25jZXB0X3BiXCI7XG5pbXBvcnQgVHJhbnNhY3Rpb25Qcm90byBmcm9tIFwiZ3Jha25sYWJzLXByb3RvY29sL3Byb3RvYnVmL3RyYW5zYWN0aW9uX3BiXCI7XG5pbXBvcnQgVHJhbnNhY3Rpb24gPSBHcmFrbi5UcmFuc2FjdGlvbjtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFR5cGVJbXBsIGltcGxlbWVudHMgVHlwZSB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfbGFiZWw6IHN0cmluZztcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9yb290OiBib29sZWFuO1xuXG4gICAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKGxhYmVsOiBzdHJpbmcsIHJvb3Q6IGJvb2xlYW4pIHtcbiAgICAgICAgaWYgKCFsYWJlbCkgdGhyb3cgbmV3IEdyYWtuQ2xpZW50RXJyb3IoRXJyb3JNZXNzYWdlLkNvbmNlcHQuTUlTU0lOR19MQUJFTC5tZXNzYWdlKCkpO1xuXG4gICAgICAgIHRoaXMuX2xhYmVsID0gbGFiZWw7XG4gICAgICAgIHRoaXMuX3Jvb3QgPSByb290O1xuICAgIH1cblxuICAgIGdldExhYmVsKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9sYWJlbDtcbiAgICB9XG5cbiAgICBpc1Jvb3QoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yb290O1xuICAgIH1cblxuICAgIGlzUmVtb3RlKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGAke3RoaXMuY29uc3RydWN0b3IubmFtZX1bbGFiZWw6JHt0aGlzLl9sYWJlbH1dYDtcbiAgICB9XG5cbiAgICBhYnN0cmFjdCBhc1JlbW90ZSh0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb24pOiBSZW1vdGVUeXBlO1xufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUmVtb3RlVHlwZUltcGwgaW1wbGVtZW50cyBSZW1vdGVUeXBlIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9ycGNUcmFuc2FjdGlvbjogUlBDVHJhbnNhY3Rpb247XG4gICAgcHJpdmF0ZSBfbGFiZWw6IHN0cmluZztcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9pc1Jvb3Q6IGJvb2xlYW47XG5cbiAgICBwcm90ZWN0ZWQgY29uc3RydWN0b3IodHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uLCBsYWJlbDogc3RyaW5nLCBpc1Jvb3Q6IGJvb2xlYW4pIHtcbiAgICAgICAgaWYgKCF0cmFuc2FjdGlvbikgdGhyb3cgbmV3IEdyYWtuQ2xpZW50RXJyb3IoRXJyb3JNZXNzYWdlLkNvbmNlcHQuTUlTU0lOR19UUkFOU0FDVElPTi5tZXNzYWdlKCkpO1xuICAgICAgICBpZiAoIWxhYmVsKSB0aHJvdyBuZXcgR3Jha25DbGllbnRFcnJvcihFcnJvck1lc3NhZ2UuQ29uY2VwdC5NSVNTSU5HX0xBQkVMLm1lc3NhZ2UoKSk7XG4gICAgICAgIHRoaXMuX3JwY1RyYW5zYWN0aW9uID0gdHJhbnNhY3Rpb24gYXMgUlBDVHJhbnNhY3Rpb247XG4gICAgICAgIHRoaXMuX2xhYmVsID0gbGFiZWw7XG4gICAgICAgIHRoaXMuX2lzUm9vdCA9IGlzUm9vdDtcbiAgICB9XG5cbiAgICBnZXRMYWJlbCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fbGFiZWw7XG4gICAgfVxuXG4gICAgaXNSb290KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5faXNSb290O1xuICAgIH1cblxuICAgIGlzUmVtb3RlKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBhc3luYyBzZXRMYWJlbChsYWJlbDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZShuZXcgQ29uY2VwdFByb3RvLlR5cGUuUmVxKClcbiAgICAgICAgICAgIC5zZXRUeXBlU2V0TGFiZWxSZXEobmV3IENvbmNlcHRQcm90by5UeXBlLlNldExhYmVsLlJlcSgpLnNldExhYmVsKGxhYmVsKSkpO1xuICAgICAgICB0aGlzLl9sYWJlbCA9IGxhYmVsO1xuICAgIH1cblxuICAgIGFzeW5jIGlzQWJzdHJhY3QoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiAoYXdhaXQgdGhpcy5leGVjdXRlKG5ldyBDb25jZXB0UHJvdG8uVHlwZS5SZXEoKVxuICAgICAgICAgICAgLnNldFR5cGVJc0Fic3RyYWN0UmVxKG5ldyBDb25jZXB0UHJvdG8uVHlwZS5Jc0Fic3RyYWN0LlJlcSgpKSkpXG4gICAgICAgICAgICAuZ2V0VHlwZUlzQWJzdHJhY3RSZXMoKS5nZXRBYnN0cmFjdCgpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBzZXRTdXBlcnR5cGUodHlwZTogVHlwZSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBhd2FpdCB0aGlzLmV4ZWN1dGUobmV3IENvbmNlcHRQcm90by5UeXBlLlJlcSgpXG4gICAgICAgICAgICAuc2V0VHlwZVNldFN1cGVydHlwZVJlcShuZXcgQ29uY2VwdFByb3RvLlR5cGUuU2V0U3VwZXJ0eXBlLlJlcSgpLnNldFR5cGUoQ29uY2VwdFByb3RvQnVpbGRlci50eXBlKHR5cGUpKSkpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldFN1cGVydHlwZSgpOiBQcm9taXNlPFR5cGVJbXBsPiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlOiBDb25jZXB0UHJvdG8uVHlwZS5HZXRTdXBlcnR5cGUuUmVzID0gKGF3YWl0IHRoaXMuZXhlY3V0ZShuZXcgQ29uY2VwdFByb3RvLlR5cGUuUmVxKClcbiAgICAgICAgICAgIC5zZXRUeXBlR2V0U3VwZXJ0eXBlUmVxKG5ldyBDb25jZXB0UHJvdG8uVHlwZS5HZXRTdXBlcnR5cGUuUmVxKCkpKSlcbiAgICAgICAgICAgIC5nZXRUeXBlR2V0U3VwZXJ0eXBlUmVzKCk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmdldFJlc0Nhc2UoKSA9PT0gQ29uY2VwdFByb3RvLlR5cGUuR2V0U3VwZXJ0eXBlLlJlcy5SZXNDYXNlLlRZUEUgPyBDb25jZXB0UHJvdG9SZWFkZXIudHlwZShyZXNwb25zZS5nZXRUeXBlKCkpIDogbnVsbDtcbiAgICB9XG5cbiAgICBnZXRTdXBlcnR5cGVzKCk6IFN0cmVhbTxUeXBlSW1wbD4ge1xuICAgICAgICBjb25zdCBtZXRob2QgPSBuZXcgQ29uY2VwdFByb3RvLlR5cGUuUmVxKCkuc2V0VHlwZUdldFN1cGVydHlwZXNSZXEobmV3IENvbmNlcHRQcm90by5UeXBlLkdldFN1cGVydHlwZXMuUmVxKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy50eXBlU3RyZWFtKG1ldGhvZCwgcmVzID0+IHJlcy5nZXRUeXBlR2V0U3VwZXJ0eXBlc1JlcygpLmdldFR5cGVMaXN0KCkpO1xuICAgIH1cblxuICAgIGdldFN1YnR5cGVzKCk6IFN0cmVhbTxUeXBlSW1wbD4ge1xuICAgICAgICBjb25zdCBtZXRob2QgPSBuZXcgQ29uY2VwdFByb3RvLlR5cGUuUmVxKCkuc2V0VHlwZUdldFN1YnR5cGVzUmVxKG5ldyBDb25jZXB0UHJvdG8uVHlwZS5HZXRTdWJ0eXBlcy5SZXEoKSk7XG4gICAgICAgIHJldHVybiB0aGlzLnR5cGVTdHJlYW0obWV0aG9kLCByZXMgPT4gcmVzLmdldFR5cGVHZXRTdWJ0eXBlc1JlcygpLmdldFR5cGVMaXN0KCkpO1xuICAgIH1cblxuICAgIGFzeW5jIGRlbGV0ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlKG5ldyBDb25jZXB0UHJvdG8uVHlwZS5SZXEoKS5zZXRUeXBlRGVsZXRlUmVxKG5ldyBDb25jZXB0UHJvdG8uVHlwZS5EZWxldGUuUmVxKCkpKTtcbiAgICB9XG5cbiAgICBhc3luYyBpc0RlbGV0ZWQoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiAhKGF3YWl0IHRoaXMuX3JwY1RyYW5zYWN0aW9uLmNvbmNlcHRzKCkuZ2V0VHlwZSh0aGlzLl9sYWJlbCkpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXQgdHJhbnNhY3Rpb24oKTogVHJhbnNhY3Rpb24ge1xuICAgICAgICByZXR1cm4gdGhpcy5fcnBjVHJhbnNhY3Rpb247XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHR5cGVTdHJlYW0obWV0aG9kOiBDb25jZXB0UHJvdG8uVHlwZS5SZXEsIHR5cGVHZXR0ZXI6IChyZXM6IENvbmNlcHRQcm90by5UeXBlLlJlcykgPT4gQ29uY2VwdFByb3RvLlR5cGVbXSk6IFN0cmVhbTxUeXBlSW1wbD4ge1xuICAgICAgICBjb25zdCByZXF1ZXN0ID0gbmV3IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVxKCkuc2V0VHlwZVJlcShtZXRob2Quc2V0TGFiZWwodGhpcy5fbGFiZWwpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3JwY1RyYW5zYWN0aW9uLnN0cmVhbShyZXF1ZXN0LCByZXMgPT4gdHlwZUdldHRlcihyZXMuZ2V0VHlwZVJlcygpKS5tYXAoQ29uY2VwdFByb3RvUmVhZGVyLnR5cGUpKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgdGhpbmdTdHJlYW0obWV0aG9kOiBDb25jZXB0UHJvdG8uVHlwZS5SZXEsIHRoaW5nR2V0dGVyOiAocmVzOiBDb25jZXB0UHJvdG8uVHlwZS5SZXMpID0+IENvbmNlcHRQcm90by5UaGluZ1tdKTogU3RyZWFtPFRoaW5nSW1wbD4ge1xuICAgICAgICBjb25zdCByZXF1ZXN0ID0gbmV3IFRyYW5zYWN0aW9uUHJvdG8uVHJhbnNhY3Rpb24uUmVxKCkuc2V0VHlwZVJlcShtZXRob2Quc2V0TGFiZWwodGhpcy5fbGFiZWwpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3JwY1RyYW5zYWN0aW9uLnN0cmVhbShyZXF1ZXN0LCByZXMgPT4gdGhpbmdHZXR0ZXIocmVzLmdldFR5cGVSZXMoKSkubWFwKENvbmNlcHRQcm90b1JlYWRlci50aGluZykpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBleGVjdXRlKG1ldGhvZDogQ29uY2VwdFByb3RvLlR5cGUuUmVxKTogUHJvbWlzZTxDb25jZXB0UHJvdG8uVHlwZS5SZXM+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBUcmFuc2FjdGlvblByb3RvLlRyYW5zYWN0aW9uLlJlcSgpLnNldFR5cGVSZXEobWV0aG9kLnNldExhYmVsKHRoaXMuX2xhYmVsKSk7XG4gICAgICAgIHJldHVybiB0aGlzLl9ycGNUcmFuc2FjdGlvbi5leGVjdXRlKHJlcXVlc3QsIHJlcyA9PiByZXMuZ2V0VHlwZVJlcygpKTtcbiAgICB9XG5cbiAgICB0b1N0cmluZygpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gYCR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfVtsYWJlbDoke3RoaXMuX2xhYmVsfV1gO1xuICAgIH1cblxuICAgIGFic3RyYWN0IGFzUmVtb3RlKHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbik6IFJlbW90ZVR5cGVJbXBsO1xufVxuIl19